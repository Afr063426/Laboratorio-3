---
title: "Laboratorio 3"
date: "`r Sys.Date()`"
output:
  rmdformats::downcute:
    highlight: kate
    toc_depth: 3
    embed_fonts: true
    use_bookdown: false
    pandoc_args: Null 
---


```{r setup, include=FALSE}
library(knitr)
library(rmdformats)
library(kableExtra)
library(tidyverse)
library(readxl)
library(ggplot2)
library(lubridate)
##install.packages('magick') para dibujos tikz
##install.packages('pdftools')

#tinytex::install_tinytex()
library(pdftools)
library(magick)
## Global options
options(max.print="75")
opts_chunk$set(echo=FALSE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

```{r}
##Se cargan los datos que se van a utilizar y se preparan para la utilización 

Precios<-read_excel("Datos históricos INCa.xlsx")
Precios$Fecha<-as.Date(Precios$Fecha,format="%d.%m.%Y")

Precios$Apertura<-gsub(",",".",Precios$Apertura )
Precios$Máximo<-gsub(",",".",Precios$Máximo )
Precios$Mínimo<-gsub(",",".",Precios$Mínimo )
Precios$Último<-gsub(",",".",Precios$Último )
Precios$`% var.`<-gsub(",",".",Precios$`% var.` )

Precios$Apertura<-as.numeric(Precios$Apertura)
Precios$Máximo<-as.numeric(Precios$Máximo)
Precios$Mínimo<-as.numeric(Precios$Mínimo)
Precios$Último<-as.numeric(Precios$Último)


Montos <- read_excel("Montos.xlsx")
Montos$FechaDePago<-as.Date(Montos$FechaDePago,format="%Y.%m.%d")
Montos<-Montos[15:19,1:4]
## Primero se trabaja con las tasas elaboradas por el banco central de Costa Rica
### Estos eran las tasas vigentes de la semana del 23 de junio del 2021 hasta el 29 de junio del 2021
tasasBCCR<-read_xlsx("Curva soberana.xlsx")



### Primero se genera una tabla con los días no bursatiles en Costa Rica de acuerdo a la bolsa nacional de valores en el año 2021
fecha<-as.Date(c("01/01/2021","01/04/2021","02/04/2021","03/05/2021","26/07/2021","02/08/2021","13/09/2021","29/11/2021","25/12/2021","31/12/2021"),format="%d/%m/%Y")
descripcion<-c("Año Nuevo","Jueves Santo", "Viernes Santo","Día del Trabajador","Anexión del partido de Nicoya","Día de la Virgen de Los Ángeles","Independecia","Día de la Abolición del Ejercitos","Día de Navidad","Feriado Banco Central")
tablaConDiaNB<-data.frame(Fecha=fecha,Descripción=descripcion)
tablaKableConDiaNB<-tablaConDiaNB%>%kbl(caption="<center><strong>Tabla 4: Días no Bursátiles Costa Rica</center></strong>")%>%kable_material()
```



```{r}
### Se programarán en esta sección las mayoría de cuestiones necesarias para la elaboración
## del proyecto

### Primero se procede a programar la curva paramétrica del modelo de Svensson para interpolar
## la curva soberana basado en los datos que se tienen BCCR

### Modelo de Svensson programado como función
svensson<-function(beta,tiempo){
  beta[1]+beta[2]*((1-exp(-tiempo/beta[5]))/(tiempo/(beta[5])))+beta[3]*((1-exp(-tiempo/beta[5]))/(tiempo/beta[5])-exp(-tiempo/beta[5]))+beta[4]*((1-exp(-tiempo/beta[6]))/(tiempo/beta[6])-exp(-tiempo/beta[6]))
}

### Se procede a programar la función que mediante interpolación aproxima las tasas a partir de las
## con las que se cuenta


fitSvensson<-function(beta,tiempo,tasas){
  fn<-function(beta){
    sum((tasas-svensson(beta,tiempo))^2) ### Suma de resta de cuadrados
  }
  optim(beta,   ### Se optimizan la suma de resta de cuadrados para tener el menor error posible
        fn,
        method = "L-BFGS-B",
        lower=rep(-20,6),
        upper = rep(20,6)
        )
  
}


### Se procede a programar el árbol binomial, para este lo que se le introducirá a la función será el la volatilidad en el periodo junto con la cantidad de pasos que se quieren hacer y el largo de cada paso. La volatilidad, es determinada de forma separada. Se va hacer que la función retorne el árbol en forma de matriz, si el paso a parece a la derecha es el aumento si a parece a la izquierda del padre es porque disminuye, tambien se le pasa el precio S_0

arbolBinarioM<-function(n,hn,volatilidad,S_0){
  u<-exp(volatilidad*sqrt(hn))
  d<-exp(-volatilidad*sqrt(hn))
  ### La cantidad de columnas de la matriz es n+1 ya que hay n+1 precios posibles en el paso final
  ### La cantidad de filas van a ser n+1 ya que son los n pasos y el precio incial
  arbol<-matrix(nrow=n+1,ncol = 2*n+1)
  arbol[1,n+1]<-S_0
  for(i in 1:n){
    for(j in 1:(2*n+1)){
      if(!is.na(arbol[i,j])){
        arbol[i+1,j-1]<-arbol[i,j]*d
        arbol[i+1,j+1]<-arbol[i,j]*u
      }
    }
  }
  return(arbol)
}

### Se procede a programar el árbol binomial, pero de el caso de las opciones de compra
arbolBinarioC<-function(n,hn,volatilidad,S_0,r,p,K,q){
  ### La cantidad de columnas de la matriz es n+1 ya que hay n+1 precios posibles en el paso final
  ### La cantidad de filas van a ser n+1 ya que son los n pasos y el precio incial
  arbol<-matrix(nrow=n+1,ncol = 2*n+1)
  arbol[n+1,]<-(0<(arbolBinarioM(n,hn,volatilidad,S_0)[n+1,]-K))*(arbolBinarioM(n,hn,volatilidad,S_0)[n+1,]-K)
  for(i in (n+1):2){
    for(j in 1:(2*n-1)){
      if(!is.na(arbol[i,j])){
        arbol[i-1,j+1]<-(arbol[i,j]*(1-p)+arbol[i,j+2]*(p))*exp(-hn*(r-q))
      }
    }
  }
  return(arbol)
}

### Función de parámetros en esta función se programará la probabilidad de aumentos, el aumento por paso, el valor mínimo de aumentos que debe haber para que la opción se ejecute
## K es el precio de ejercicio
## S_0 el precio actual
## n es el numero de pasos
## hn el largo de los pasos
## La volatilidad en el periodo es la varianza calculada mediante los datos que se tengan
## r es la tasa libre de riesgo en el periodo
## q es el porcentaje de dividendo que se paga sobre la acción
## Estas variables con esta notación se mantiene para las siguientes funciones
parametros<-function(K,S_0,n,hn,volatilidad,r,q){
  u<-exp(volatilidad*sqrt(hn)) ## Este es el aumento en cada paso
  d<-1/u
  p<-(exp((r-q)*hn)-d)/(u-1/u) ## Esta es la probabilidad del aumento
  a<-ceiling(log(K/(S_0*1/u^n))/log(u^2))  ## Esta es la cantidad minima de aumentos
  return(c(a,p,u))
}



### Se procede a programar la forma en que se calculan los precios de las opciones, caso call europea

precioC<-function(K,S_0,n,hn,volatilidad,r,q){
  parametros<-parametros(K,S_0,n,hn,volatilidad,r,q)
  sum((choose(n,c(parametros[1]:n))*parametros[2]^(c(parametros[1]:n))*(1-parametros[2])^(n-c(parametros[1]:n)))*(parametros[3]^(c(parametros[1]:n))*(1/parametros[3])^(n-c(parametros[1]:n))*S_0-K))*(exp(-n*hn*(r-q)))### Formula para precio de de las opciones de compra
}

### De forma análoga se programa el precio de una put option europea
precioP<-function(K,S_0,n,hn,volatilidad,r,q){
  parametros<-parametros(K,S_0,n,hn,volatilidad,r,q)
  -sum((choose(n,c(0:(parametros[1]-1)))*parametros[2]^(c(0:(parametros[1]-1)))*(1-parametros[2])^(n-c(0:(parametros[1]-1))))*(parametros[3]^(c(0:(parametros[1]-1)))*(1/parametros[3])^(n-c(0:(parametros[1]-1)))*S_0-K))*(exp(-n*hn*(r-q)))### Formula para precio de de las opciones de venta
}
```


    
    
    
# Introducción









# Marco teórico

En primera instancia se muestra la notación que se mantiene a lo largo del trabajo para facilitar su comprensión, teniendo así la siguiente tabla.

```{r}
notacion<-c("$t_j$","$t_0$","$t_f$","$\\tau$","$n$","$h_n$","$S(t_j),S_{j}$","$p_n$","$1-p_n$","$u_n$","$d_n$","$q$", "$D(t_j,t_j)=qS_{j-1}h_n$","$r$","$K$","$C_j$","$P_j$")
significado<-c("Tiempo $j$.","Tiempo inicial.","Tiempo final.","$t_f-t_0$.","Cantidad de periodos en el que se divide $[t_0,t_f]$.","Largo de cada periodo en el se divide $[t_0,t_f]$, espeficamente el largo es $\\frac{\\tau}{n}$.","Precio de la acción en el tiempo j.","Probabilidad de que el precio de la acción aumente de un periodo a otro.","Probabilidad de que el precio de la acción disminuya de un periodo a otro.","Proporción en que aumenta el precio del activo de un periodo a otro.","Proporción en que disminuye el precio de la activo de un periodo a otro.","Proporción de dividendo.","Monto pagado de dividendo en el momento $j$.","Tasa libre de riesgo.","Precio de ejercicio.","Precio de la opción de compra en $j$.","Precio de la opción de venta en $j$.")
tablaNotacion<-data.frame(Notacion=notacion,Significado=significado)
tablaNotacion%>%kbl(col.names = c("Notación","Significado"),caption="<center><strong>Tabla 1: Notación</strong></center>
")%>%kable_material()%>%kable_styling(full_width = F)
```

Existen distintos métodos para la valoración de opciones, entre ellos los que se basan en métodos numéricos como lo expone Marín (2009) existen el de Monte Carlo, diferencias finitas, árboles binomiales y trinomiales. A lo largo de este trabajo se implementa la valoración de las opciones bajo el modelo de árboles binomiales. Los modelos basados en métodos numéricos a diferencia de otros poseen la ventaja de que su implementación es computacionalmente más simple y eficiente que el desarrollo de soluciones analíticas para la valoración de las opciones, basado en el comportamiento del activo subyacente.

Se procede a explicar lo que son los árboles binomiales, así como su construcción. De acuerdo con el texto _An introduction to Mathematical Finance with Application_, los árboles binomiales muestran los posibles precios futuros de un activo basado en el conocimiento del precio actual. Para este modelo se parte de un intervalo $[t_0,t_f]$, este intervalo es subdivido en $n$ subintervalos del mismo largo llamados pasos de tiempo, así se obtienen los intervalos $[t_0,t_1],[t_1,t_2],...,[t_{n-1},t_{n}]$ donde

\[
0\leq t_0,\quad t_1=t_0+h_n,\quad t_2=t_0+2h_n,\quad...,\quad t_{n-1}=t_0+(n-1)h_n,\quad t_n=t_0+nh_n=t_f
\]

Gráficamente un árbol binomial.

<caption><center><strong>Figura 1: Árbol Binomial de Dos Pasos</strong></center></caption>
```{tikz , fig.ext = 'png'}
\usetikzlibrary{arrows}
\usetikzlibrary{trees}
\usetikzlibrary{matrix}
  \begin{tikzpicture}[>=stealth,sloped]
    \matrix (tree) [%
      matrix of nodes,
      minimum size=1cm,
      column sep=3.5cm,
      row sep=1cm,
    ]
    {
          &   & $S_0u_2^2$ \\
          & $S_0u_2$ &   \\
      $S_0$ &   & $S_0u_2d_2$ \\
          & $S_0d_2$ &   \\
          &   & $S_0d^2$ \\
    };
    \draw[->] (tree-3-1) -- (tree-2-2) node [midway,above] {$p$};
    \draw[->] (tree-3-1) -- (tree-4-2) node [midway,below] {$(1-p)$};
    \draw[->] (tree-2-2) -- (tree-1-3) node [midway,above] {$p^2$};
    \draw[->] (tree-2-2) -- (tree-3-3) node [midway,below] {$(1-p)p$};
    \draw[->] (tree-4-2) -- (tree-3-3) node [midway,above] {$(1-p)p$};
    \draw[->] (tree-4-2) -- (tree-5-3) node [midway,below] {$(1-p)^2$};
  \end{tikzpicture}
```
<subcaption><small>Fuente: Elaboración propia, basado en código de user71804 https://tex.stackexchange.com/questions/227414/draw-5-period-binomial-tree</small></subcaption>


## Aspectos estadísticos

Es importante tener presentes algunos aspectos estadísticos que posteriormente serán útiles al momento de hablar del árbol binomial, por lo que primeramente se presentan un par de definiciones, según Evans y Rosenthal (2010).

La media se define como: 
\[
\mu_X=\frac{1}{|\Pi|}\sum_{\pi\in \Pi}X(\pi)
\]
Mientras que la desviación estándar:

\[
\sqrt{\text{Var}(X)}=\sigma_{X}=\frac{1}{|\Pi|}\sqrt{\sum_{\pi\in \Pi}(X(\pi)-\mu_X)^2}
\]

Donde $\Pi$ son los datos y $X$ es el peso dado a cada dato. En particular, la media muestral es igual:
\[
\bar{x}=\frac{1}{n}\sum_{i=1}^{n}x_i
\]
Y la desviación estándar muestral es:

\[
\sigma_X=\sqrt{\frac{1}{n-1}\sum_{i=1}^{n}(x_i-\bar{x})^2}
\]

Con esto presente se deben asumir algunos supuestos para poder trabajar con los árboles binomiales.

## Supuestos para trabajar con árboles binomiales
* Propiedad de recombinación: si el precio aumenta en un paso y en el siguiente disminuye, entonces se obtiene el precio que se tenía antes de que se hiceran ambos pasos, esto es $S_ju_nd_n=S_jd_nu_n$ con $j\leq n-2$. A partir de esta propiedad se obtiene que la cantidad posible de precios que tiene el activo en el tiempo $t_n$ son $n+1$. Además, se cumple que la forma en que aumenta el precio es totalmente aleatoria, cumpliendo:

\[
S(t_j)=S_0u_n^{N_{u,j}}u_n^{1-N_{u,j}}
\]

Donde $N_{u,j}$ es la variable aletoria denominada cantidad de aumentos hasta el periodo $j$ partiendo del periodo $0$.

* Retorno bruto, ganancia de capital y retorno logarítmico: para cada paso de tiempo $[t_{j-1},t_{j}]$, donde $j=1,\dots,n$, el aumento o disminución del precio del activo es el retorno bruto $\frac{S_j}{S_{j-1}}$. Cada uno de estos retornos es asumido independiente e idénticamente distribuido (i.i.d.), de hecho se asumen variables aleatorias con distribución de Bernoulli. 

\[
\frac{S_j}{S_{j-1}}=\begin{cases}
u_n & \text{con probabilidad $p_n$}\\
d_n & \text{con probabilidad $1-p_n$}
\end{cases}
\]

Las ganancias de capital son iguales a $\mathbf{R_j}=\frac{S_j}{S_{j-1}}-1$ con $j=1,...,n$, que también son variables aleatorias i.i.d. y son independientes.
Así mismo los retornos logarítmicos que son $\ln\frac{ S_j}{ S_{j-1}}$ con $j=1,...,n$.

\[
\ln\frac{S_j}{S_{j-1}}=\begin{cases}
\ln{u_n} & \text{con probabilidad $p_n$}\\
\ln{d_n} & \text{con probabilidad $1-p_n$}
\end{cases}
\]

* La tripleta $p_n,u_n,d_n$: estas cantidades dependen del tamaño $h_n$.

* Medida de la probabilidad: la probabilidad de que un camino de precios ocurra es obtenido mediante la multiplicación de las probabilidades a lo largo del camino. Esto es si $N_u$ es la variable aleatoria número de aumentos de la seguridad desde $t_0$ hasta $t_f$ y $\Omega_n$ es el espacio muestral, entonces:

\[
\mathbb{P}(w_n)=p_n^{N_u(\omega_n)}(1-p_n)^{N_u(\omega_n)}
\]

Ahora bajo el supuesto de que los caminos de precio son independientes, entonces se cumple que la probabilidad de tener un determinado precio en el momento $t_f$ es:

\[
\mathbb{P}(S(t_n)=S_0u_n^id_n^{n-i})=\binom{n}{i}p^{i}(1-p_n)^{n-i}
\]

Lo que muestra que los precios están distribuidos de forma binomial.

* Se supone que el activo paga un dividendo constante, continuo y proporcional al precio final de todo el tiempo $[t_0,t_f]$, de tal forma que:

\[
D(t_{j-1},t_{j})=qS_{j-1}h_n, \quad j=1,2,..,n
\]

* La tasa de retorno total es: 

\[
R(t_{j-1},t_j)=\frac{S_j-S_{j-1}+D(t_{j-1},t_{j})}{S_{j-1}}=\mathbf{R_j}+qh_n
\]

Con estos supuestos, se procede a exponer el modelo de Cox-Ross-Rubinstein (CRR), el cual puede ser empleado para valorar las opciones de compra y de venta.

## Árbol de Cox-Ross-Rubinstein 

El árbol binomial CRR cumple todas las suposiciones que se hicieron en la anterior subsección, este permite determinar $u_n,d_n$ y $p_n$ en términos de periodos de largo $h_n$ para un $n$ suficientemente grande.

Para este modelo hace falta tomar algunas suposiciones aparte de las anteriores.

* Casi seguramente caminos muestrales de precios continuos: los caminos muestrales de precios son continuos cuando $n\to\infty$.

* Retornos esperados: los retornos esperados convergen a una constante $m$

\[
\frac{\mathbb{E}(R(t_0,t_1))}{h_n}\to m, \qquad n\to \infty
\]

Ahora se destaca que el retorno se puede obtener mediante la ganancia de capital y la proporción de dividendo $qh_j$ esto es $R(t_0,t_1)=\mathbf{R}_1+qh_n$, entonces:

\[
\frac{\mathbb{E}(\mathbf{R_1})}{h_n}=\frac{\mathbb{E}(R(t_0,t_1)-q)}{h_n}\to m-q
\]

$m$ y $q$ se asumen dados, de tal forma que $m$ corresponde al retorno esperado.

* Constante $\mu_{RW}$:  se define $\mu_n$ como el retorno logaritmico de cada paso:

\[
\mu_n=\frac{1}{h_n}\mathbb{E}\left(\ln\left(\frac{S_1}{S_0}\right)\right)
\]

Que explícitamente por como se asumieron se distribuyen los retornos logarítmicos da como resultado
\[
\mu_nh_n=p_n\ln u_n+(1-p_n)\ln{d_n}
\]

Como los retornos logarítimicos en cada paso están identicamente distribuidos, entonces el retorno logarítmicos sobre todo el intervalo $[t_0,t_f]$ es igual a:

\[
\mathbb{E}\left(\ln\left(\frac{S_n}{S_0}\right)\right)=n\mathbb{E}\left(\ln\left(\frac{S_1}{S_0}\right)\right)=\mu_n\tau
\]

Ahora se asume que $\mu_n$ converge a una constante:

\[
\mu_n\to\mu_{RW}, \quad n\to \infty
\]

A esta constante se le llama _drift_.
* La constante $\sigma$: si se define $\sigma^2_n$ la varianza de los retornos logarítmicos por cada paso, entonces

\[
\sigma_n^2=\frac{1}{h_n}\text{Var}\left(\ln\frac{S_1}{S_0}\right)
\]

Por la forma en que se distribuyen los retornos logarítmicos, entonces:

\[
\sigma_n^2h_n=p_n(1-p_n)\left[\ln\frac{S_1}{S_0}\right]
\]

Como los retornos logaritmicos están i.i.d. entonces, se cumple que la varianza del retorno en el intervalo $[t_0,t_f]$ es $n$ veces la varianza de cada paso de tiempo:

\[
\text{Var}\left(ln\frac{S_n}{S_0}\right)=n\text{Var}\left(\frac{S_1}{S_0}\right)
\]

Se asume que $\sigma^2_n\to \sigma^2>0$ cuando $n\to \infty$. Esto se le llama la volatilidad del precio del activo. 

Es importante aquí recalcar que se puede establecer una relación entre lo que sería $m-q$ y $\sigma$ para poder determinar el _drift_ en términos de estos dos, de tal forma que se logra obtener:

\[
\mu_{RW}=m-q-\frac{\sigma^2}{2}
\]

Sin embargo tal y como lo exponen Cox, Ross y Rubinstein (1979), el determinar el valor de $m$ se puede volver un poco engorroso, por lo que tal y como lo proponen, se puede asumir que el _drift_ sea aproximado por la media muestral, así como la volatilidad puede ser aproximada mediante la desviación estándar. Ahora para $n$ lo suficientemente grande se establece que se cumple lo siguiente:

\[
u_n\approx e^{\sigma\sqrt{h_n}},\quad d_n\approx e^{\sigma\sqrt{h_n}}, \quad p_n\approx \frac{1}{2}+\frac{\mu_{RW}}{\sigma}\sqrt{h_n}
\]

Ahora los inversores pueden elegir ser más, o menos adversos al riesgo. Sin embargo, a partir del modelo CRR se puede proponer que los inversores sean neutrales al riesgo, en estos casos se establece como el precio del activo está compuesto continuamente mediante una tasa libre de riesgo $r$ menos la tasa de dividendos $q$. De tal forma, para este caso de inversores con riesgo neutral, se obtiene:

\[
u_n\approx e^{\sigma\sqrt{h_n}},\quad d_n\approx e^{'\sigma\sqrt{h_n}}, \quad p_n\frac{e^{(r-q)h_n}-d_n}{u_n-d_n}
\]

Note que para la primera lista de ecuaciones se emplea implícitamente el valor de $m$ mientras que para la segunda se ha empleado una tasa libre de riesgo. No obstante, bajo el modelo de Black y Scholes para la valoración de opciones, se puede establecer la tasa libre de riesgo es independiente de $m$. De tal forma que es erróneo pensar que se cumple, al menos en este trabajo:

\[
r=m
\]


## Opciones

Las opciones son un contrato entre dos partes, en el cual uno de los involucrados tiene la posibilidad de no ejercer el contrato, cuando este no le sea favorable. En este caso al vendedor de la opción se le llama escritor el cual se dice toma la posición corta, mientras el comprador, se dice que toma la posición larga. Las opciones a trabajar son las de compra y las de venta.

Tal y como lo destacan Boudreault y Renaud (2019), una opción de compra da el derecho de obtener en un momento establecido entre las partes un activo a un precio establecido $K$, llamado precio de ejercicio. Al precio $S_T$, donde $T$ es el momento establecido en el cual se puede ejercer el derecho de compra, hay dos posibilidades:

1. $S_T>K$ en este caso se dice que la opción está en el dinero, ya que es conveniente ejercer el derecho.

2. $S_T\leq K$ en este caso se dice que la opción está fuera del dinero, ya que no es razonable ejercer el derecho, se estaría comprando algo de menor valor o del mismo valor al establecido como el de ejercicio, en cuyo caso se va establecer que el poseedor del derecho decide no ejercer la opción.

Los flujos de dinero en el caso de la posición larga vienen dados por:

```{r}
tiempoLongCall<-c("Momento $t_0$","Momento $T$")
SmenorK<-c("$-C_0$","$0$")
SmayorK<-c("$-C_0$","$S_T-K$")
tablaLongCall<-data.frame("Tiempo/Escenario"=tiempoLongCall,"$S_T< K$"=SmenorK,"$S_T \\geq K$"=SmayorK)
tablaLongCall%>%kbl(col.names = c('Tiempo/Escenario','$S_T \\leq K$',"$S_T$ > $K$"),caption="<center><strong>
Tabla 2: Flujos Opción de Compra, Posición Larga. </strong></center>
")%>%kable_material()
```

Las opciones se pueden emplear en distintas circunstancias entre las motivaciones para escribir o comprar una opción están la especulación o el cubrirse de algún riesgo. De tal forma que se pueden establecer distintas estrategias de compra y venta de opciones, combinado con otros instrumentos de inversión de tal forma que se puedan replicar portafolios. Un aspecto importante es que se puede concluir que las posibilidades de arbitraje con opciones existen, sin embargo rápidamente los mercados financieros hacen que esa oportunidad que existía hacia algunos instantes desaparezca. Además existen los distintos tipos de opciones como lo son:

* Opción europea: solo puede ser ejercida en la fecha de vencimiento establecida entre ambas partes
* Opción americana: puede ser ejercida durante todo el periodo que tenga el derivado hasta la fecha de maduración.
* Opciones exóticas: existen otras opciones como lo son la asiática, opción al pasado y la opción de intercambio.

De una forma análoga se puede establecer que las opciones de venta son un derecho de poder vender un activo a un precio establecido por ambas partes llamado precio de ejercicio $K$, en el caso contrario al de las opciones de compra el derecho es ejercido cuando el precio $S_T$ es menor que el precio de ejercicio, y si es mayor o igual, no es ejercido. Los flujos en el caso de la posición larga vienen dados por:

```{r}
tiempoLongCall<-c("Momento $t_0$","Momento $T$")
SmenorK<-c("$-C_0$","$K-S_T$")
SmayorK<-c("$-C_0$","$0$")
tablaLongCall<-data.frame("Tiempo/Escenario"=tiempoLongCall,"$S_T\\leq K$"=SmenorK,"$S_T$ > $K$"=SmayorK)
tablaLongCall%>%kbl(col.names = c("Tiempo/Escenario","$S_T$ < $K$","$S_T \\geq K$"),caption="<center><strong>
Tabla 3: Flujos Opción de Venta, Posición Larga</strong></center>
")%>%kable_material()
```

## Precio de las opciones

Ahora surge la duda, cuál debería ser el precio de adquirir una opción. Las opciones tienen una larga historia, pero el cómo establecer el precio tuvo un gran cambio en el año 1973 cuando Black y Scholes presentaron un modelo con el cual se lograba obtener un precio de equilibrio para las opciones. Esta subsección se centrará en el cómo se estable el precio de una opción, sin embargo, con una matemática menos avanzada que con el modelo establecido por Black y Scholes, y basado en el uso de árboles binomiales presentados en una de las subsecciones anteriores.

El precio que tendrán la opción será establecido de acuerdo a los distintos precios que puede llegar a tener el activo subyacente después de $n$ pasos de tiempo, de tal forma que no haya una oportunidad de arbitraje con esta. Para el caso de una opción de compra a la europea tal y como lo establecen Cox, Ross y Rubinstein (1979), se tiene que su valor se basará en la diferencia que habrá entre el precio del activo subyacente y el precio de ejercicio. Así, para el caso de un árbol binomial de un periodo se tiene que si el precio aumenta, el precio de la opción es $C_u=\max\{0,uS_0-K\}$ y si el precio dismuye $C_d=\max\{0,dS_0-K\}$.

Se nota entonces que la probalidad de que el valor de la opción sea $C_u$ dentro de un paso es $p$ que coincide con la probabilidad de que el precio del activo subyacente aumente. Mientras que la probailidad de que sea $C_d$ es igual a $1-p$. De acuerdo a Cox, Ross y Rubinstein (1979), basado en que se tiene un portafolio en el cual se encuentra el activo subyacente y una seguridad libre de riesgo, el precio de la opción para evitar cualquier oportunidad de arbitraje es:

\[
C=\frac{pC_u+(1-p)C_d}{1+r}
\]

Ahora para el caso de se tenga un árbol binomial de dos periodos, entonces el valor de la opción después de dos pasos, si el activo subyacente aumenta dos veces su precio, es entonces $C_{uu}=\max\{0,u^2S-k\}$. Para el caso de dos disminuciones $C_{dd}=\max\{0,d^2S-k\}$. Además, por la propiedad de recombinación, el precio del activo subyacente es igual si este aumenta y posteriormente disminuye, o si primeramente dismuye y posteriormente aumenta, entonces: $C_{du}=C_{ud}=\max\{0,udS-k\}$. 

Bajo esto, en el periodo $t_1$ la opción tiene los siguientes precios:

\[
\begin{split}
&C_u=\frac{pC_{uu}+(1-p)C_{ud}}{1+r}\\
&C_d=\frac{(1-p)C_{dd}+pC_{du}}{1+r}\\
\end{split}
\]

Ahora entonces basado en lo visto para el caso de un periodo, se cumple que: 

\[
C=\frac{p^2C_{uu}+2p(1-p)^2C_{ud}+(1-p)^2C_{dd}}{(1+r)^2}
\]

De forma recursiva entonces se puede concluir que para un árbol de $n$ periodos:

\[
C=\frac{\sum_{i=0}^{n}\left(\frac{n!}{i!(n-i)!}p^{i}(1-p)^{n-i}\max\{0,u^id^{n-i}S_0-K\}\right)}{(1+r)^{n}}
\]

Ahora el cálculo se puede volver más eficiente encontrando $a\in \{0,1,2,\dots ,n\}$, tal que:

\[
u^{a}d^{n-a}S_0-K>0
\]

Que manipulando algebraicamente da como resultado $a>\frac{K}{S_0d^n\ln{\frac{u}{d}}}$. Entonces encontrando $a$ que cumpla con estas dos condiciones, se puede establecer:
\[
C=\frac{\displaystyle\sum_{i=a}^{n}\left(\frac{n!}{i!(n-i)!}p^{i}(1-p)^{n-i}u^id^{n-i}S_0-K\}\right)}{(1+r)^{\tau}}
\]

De forma análoga, para el caso de las opciones de venta se puede establecer que el precio de la opción de venta $P$ es igual a:

\[
P=\frac{\sum_{i=0}^{a-1}\left(\frac{n!}{i!(n-i)!}p^{i}(1-p)^{n-i}u^id^{n-i}S_0-K\}\right)}{(1+r)^{n}}
\]

Ahora se procede a ver lo que es la Curva de Rendimiento Soberana.

## Curva de Rendimiento Soberana

La curva soberana es una estructura temporal de tasas que se emplea para valorar distintos instrumentos financieros. "Su comportamiento refleja en alguna medida las expectativas futuras del mercado sobre diversas variables económicas y sirve como una herramienta para la valoración de instrumentos financieros" (BCCR,s.f.). Esta curva se calcula a partir de distintos instrumentos financieros como bonos y para esto se emplean distintos modelos como lo son las curvas paramétricas.

La curva soberana del Banco Central de Costa Rica (BBCR) es determinada mediante el modelo de Svensson o el de Nelson y Siegel. Según el BCCR la curva paramétrica para el rendimiento es:

\[
y(t)=\beta_{0}+\beta_{1}\left(\frac{1-e^{\frac{-t}{\tau_1}}}{\frac{t}{\tau_1}}\right)+\beta_2\left(\frac{1-e^{\frac{-t}{\tau_1}}}{\frac{t}{\tau_1}}-e^{\frac{-t}{\tau_1}}\right)+\beta_3\left(\frac{1-e^{\frac{-t}{\tau_2}}}{\frac{t}{\tau_2}}-e^{\frac{-t}{\tau_2}}\right)
\]

Los seis parámetros del modelo pueden ser calculados mediante una interpolación, de tal forma que se toman los datos que brinda el BCCR a una fecha y se minimiza:

\[
\sum_{i=1}^{n}\left(y(t_n)-r_n\right)^2
\]

Ahora una vez se cuenta con la curva de los rendimientos, entonces se puede calcular el factor de descuento continuo:

\[
\exp\{-Ty(T,\beta,\tau)\}
\]

Esto permite componer de forma continua, que es similar a lo que pretenden los agentes que suceda con el precio de su acción. Se procede a desarrollar la metología.

# Metodología

Para el siguiente trabajo, se utiliza el programa RStudio para generar un documento RMarkdown, los cuales operan con el lenguaje de programación R. Además, mediante distintos sitios web se recuperaron datos de acciones de la empresa Holcim Costa Rica, así como la curva soberana del Banco Central de Costa Rica. Así mismo, con la información anterior se realizaron gráficos para interpretar y aplicar los datos con el trabajo teórico, logrando una aplicacion práctica del mismo. También se efectúa un análisis con la información obtenida y el modelo binomial para calcular las opciones de compra y afirmar si sería beneficionsa la inversión o no.

# Análisis de datos


Los datos de los precios del activo subyacente a analizar, en este caso acciones, son provenientes de la empresa Holcim Costa Rica, suministrados por el sitio web Investing.com y comparados con los suministrados por la misma empresa en los periodos de los que se guardaron registro, pues los mismos no contaban con un registro tan periódico como los del sitio web. Los mismos se pueden apreciar en el siguiente gráfico:


<caption><center><strong>Figura 2: Precio de las acciones de Holcim Costa Rica S.A.</strong></center></caption>
```{r}

ggplot(Precios,aes(x=Fecha, y =Último))+
  geom_line()+
  geom_point(aes(x =Montos$FechaDePago[1], y=Último[Fecha==Montos$FechaDePago[1]]), size =1,color="blue" )+
  geom_point(aes(x =Montos$FechaDePago[2], y=Último[Fecha==Montos$FechaDePago[2]]), size =1,color="blue" )+
  geom_point(aes(x =Montos$FechaDePago[3], y=Último[Fecha==Montos$FechaDePago[3]]), size =1,color="blue" )+
  geom_point(aes(x =Montos$FechaDePago[4], y=Último[Fecha==Montos$FechaDePago[4]]), size =1,color="blue" )+
  geom_point(aes(x =Montos$FechaDePago[5], y=Último[Fecha==Montos$FechaDePago[5]]), size =1,color="blue" )+
  labs(y = "Precios",x = "Tiempo")+theme_minimal()+theme(legend.position="bottom",plot.caption=element_text(hjust=0))
```
<subcaption><small>Fuente: Elaboración propia, datos Investing.com y Holcim Costa Rica S.A.</small></subcaption>


Cabe destacar que los puntos azules indican la fecha del pago de dividendos o en su defecto la fecha más próxima de la cual se tiene registro del precio de la acción. Como es observable, los pagos de dividendos no representan un cambio en el precio de las acciones, el cual tiene un comportamiento de estabilidad durante algunos meses para luego sufrir un cambio brusco.  



Se puede apreciar una caída a finales del año 2019 he inicios del 2020, esto producto de la especulación en los mercados y la venta de activos, para la obtención de dinero líquido, causado por la pandemia del COVID-19 y su afectación en los mercados. 


Para poder realizar un mejor cálculo de la opción se van a utilizar únicamente los dados obtenidos a partir del 01/03/2020, puesto que los datos anteriores presentan mucha volatilidad, por causas ajenas al compartaiento de la empresa en su activada productiva. Se presentan los datos con que se va a trabajar:

<caption><center><strong>Figura 3: Precio de las acciones de Holcim Costa Rica S.A. 01/03/2020-17/06/2021</strong></center></caption>
```{r}

Precios<-Precios[Precios$Fecha>=as.Date("01.03.2020",format="%d.%m.%Y"),]

  ggplot()+
  geom_line(aes(x=Precios$Fecha, y =Precios$`Último`))+
  geom_point(aes(x =Montos$FechaDePago[3], y=Precios$Último[Precios$Fecha==Montos$FechaDePago[3]]), size =1,color="blue" )+
  geom_point(aes(x =Montos$FechaDePago[4], y=Precios$Último[Precios$Fecha==Montos$FechaDePago[4]]), size =1,color="blue" )+
  geom_point(aes(x =Montos$FechaDePago[5], y=Precios$Último[Precios$Fecha==Montos$FechaDePago[5]]), size =1,color="blue" )+
  labs(y = "Precios",x = "Tiempo") +theme_minimal()+theme(legend.position="bottom",plot.caption=element_text(hjust=0))



```

<subcaption><small>Fuente: Elaboración propia, datos Investing.com y Holcim Costa Rica S.A.</small></subcaption>


Se debe tener presente que la Bolsa Nacional de Valores de Costa Rica únicamente trabaja en días hábiles, por lo que se tiene que tener presente los días no bursátiles en Costa Rica, los cuales son:


```{r}
tablaKableConDiaNB
```

Se va a trabajar con los datos de la curva soberana obtenidos de la página del Banco Central de Costa Rica, los mismos son establecidos para la semana del 23 de junio del año 2021 al 29 de junio de año 2021. De los cuales se tienen las siguientes observaciones: 

```{r}
tasasBCCR<-tasasBCCR[-12]
tasasBCCR<-cbind("Fechas de maduración"= c("Tasa"), tasasBCCR)
tasasBCCR%>%kbl(caption="<center><strong> Tabla 5: Tasas de Rendimiento, Curva Soberana</strong></center>")%>%kable_material()%>%kable_styling(full_width = F)
tasasBCCR<-tasasBCCR[-1]

```

<subcaption><small>Fuente: BCCR</small></subcaption>

A los anteriores datos se les aplica el modelo de paramétrico de Svensson, esto siguiendo la _Nota Metodología Curva de Rendimiento Soberana De Costa Rica_, emitida por el Banco Central de Costa Rica, obteniendo así la siguiente curva: 

<caption><center><strong>Figura 4: Curva de Rendimientos (Anual), _Svensson_ </strong></center></caption>
```{r}
#### Se calculan los parametros

tasasBCCR<-tasasBCCR%>%gather("Maduration","TasaRendimiento",1:ncol(tasasBCCR))
tasasBCCR$Maduration<-(grepl("d",tasasBCCR$Maduration)*1/365+grepl("m",tasasBCCR$Maduration)*1/12+grepl("año",tasasBCCR$Maduration))*as.numeric(substring(tasasBCCR$Maduration,1,2))
tasasBCCR$TasaRendimiento<-tasasBCCR$TasaRendimiento/100
b<-c(0,0,0,0,0.005,0.005)
parametrosFitSvensson<-fitSvensson(b,tasasBCCR$Maduration,tasasBCCR$TasaRendimiento)
parametrosModelo<-unlist(parametrosFitSvensson[1])


CurvaSven<-c(seq(1/4,10,1/4))
CurvaSven<-cbind("Fecha de maduración"= CurvaSven,"Rendimientos"=svensson(parametrosModelo, seq(1/4,10,1/4)))
CurvaSven<-as.data.frame(CurvaSven)

ggplot()+
  geom_line(aes(x=CurvaSven$`Fecha de maduración`, y = CurvaSven$Rendimientos))+
  geom_point(aes(x =tasasBCCR$Maduration, y=tasasBCCR$TasaRendimiento), size =1,color="blue" )+
  labs(y = "Rendimientos",x = "Fecha de maduración en años" ,caption = "Fuente: Elaboración propia, con datos del Banco Central de Costa Rica")+theme_minimal()+theme(legend.position="bottom",plot.caption=element_text(hjust=0))
```
<subcaption><small> Fuente: Elaboración propia, datos BCCR</small></subcaption>


```{r}

##Se procede a calcular los retornos logarítmicos de los precios de las acciones. Para esto, primero se calculan los rendimientos brutos semanales, seguidamente del logaritmo de estos


Fechas_semanales <- cut(Precios$Fecha, "week")
Fechas_semanales <- unique(Fechas_semanales)
Precios_semanales <- Precios$Último[Fechas_semanales]

retornos_brutos_semanales <- Precios_semanales[-length(Precios_semanales)]/Precios_semanales[-1]
#retornos_brutos_semanales

retornos_logaritmicos_semanales <- log(retornos_brutos_semanales)
#retornos_logaritmicos_semanales

##Luego se calcula la varianza de los resultados anteriores y posteriormente la volatilidad de los datos obtenidos

volatilidad_semanal <- sd(retornos_logaritmicos_semanales)
#varianza_retornos_logaritmicos_semanales

volatilidad_anual<- volatilidad_semanal * sqrt(52)
#volatilidad_logaritmica_semanal

```




# Análisis del árbol e implementación

El árbol binomial es útil, ya que permite calcular los posibles precios que puede llegar a tener el activo, basado en datos históricos y reduciendo los casos a un aumento o disminución en cada paso. Como se mostró en la sección para el cálculo del precio de las opciones, este se puede obtener de forma recursiva y se basa en las mismas probabilidades de que el precio del activo subyacente aumente, cumpliendo que el precio de la opción responde a una distribución binomial.

Cabe recordar que los modelos son un simplificación de la realidad, y no se deben tomar como una verdad completa, estas herramientas permiten tomar decisionces con cierto criterio. Dicho esto, se muestra una representación del precio de una opción de compra en un árbol de dos pasos.


<caption><center><strong>Figura 5: Árbol Binomial de Opción de Compra</strong></center></caption>
```{tikz, fig.ext = 'png'}
\usetikzlibrary{arrows}
\usetikzlibrary{trees}
\usetikzlibrary{matrix}
  \begin{tikzpicture}[>=stealth,sloped]
    \matrix (tree) [%
      matrix of nodes,
      minimum size=1cm,
      column sep=3.5cm,
      row sep=1cm,
    ]
    {
          &   & $C_{uu}=\max\{0,S_0u_2^2-K\}$ \\
          & $C_u$ &   \\
      $C$ &   & $C_{uu}=\max\{0,S_0u_2d_2-K\}$ \\
          & $C_d$ &   \\
          &   & $c_{dd}=\max\{0,S_0d^2-K\}$ \\
    };
    \draw[->] (tree-3-1) -- (tree-2-2) node [midway,above] {$p$};
    \draw[->] (tree-3-1) -- (tree-4-2) node [midway,below] {$(1-p)$};
    \draw[->] (tree-2-2) -- (tree-1-3) node [midway,above] {$p^2$};
    \draw[->] (tree-2-2) -- (tree-3-3) node [midway,below] {$(1-p)p$};
    \draw[->] (tree-4-2) -- (tree-3-3) node [midway,above] {$(1-p)p$};
    \draw[->] (tree-4-2) -- (tree-5-3) node [midway,below] {$(1-p)^2$};
  \end{tikzpicture}
```
<subcaption><small>Fuente: Elaboración propia, basado en código de user71804 https://tex.stackexchange.com/questions/227414/draw-5-period-binomial-tree</small></subcaption>


Donde $C_u$ y $C_d$ se calculan como se mostró en la sección del precio de las opciones. Cabe destacar que nunca se ha descartado el caso en que el precio de la opción sea 0, esto lo que expresaría es que casi seguramente el precio de la acción al final se va encontrar por debajo del precio de ejercicio $K$, lo que es lo mismo a

\[
\mathbb{P}(S_{f}\leq K)=1
\]

De forma análoga se tiene que la opción de venta da como origen a un árbol de la siguiente forma


<caption><center><strong>Figura 6: Árbol Binomial de Opción de Venta</strong></center></caption>
```{tikz, fig.ext = 'png'}
\usetikzlibrary{arrows}
\usetikzlibrary{trees}
\usetikzlibrary{matrix}
  \begin{tikzpicture}[>=stealth,sloped]
    \matrix (tree) [%
      matrix of nodes,
      minimum size=1cm,
      column sep=3.5cm,
      row sep=1cm,
    ]
    {
          &   & $P_{uu}=\max\{0,K-S_0u_2^2\}$ \\
          & $P_u$ &   \\
      $S_0$ &   & $P_{uu}=\max\{0,K-S_0u_2d_2\}$ \\
          & $P_d$ &   \\
          &   & $P_{dd}=\max\{0,K-S_0d^2\}$ \\
    };
    \draw[->] (tree-3-1) -- (tree-2-2) node [midway,above] {$p$};
    \draw[->] (tree-3-1) -- (tree-4-2) node [midway,below] {$(1-p)$};
    \draw[->] (tree-2-2) -- (tree-1-3) node [midway,above] {$P^2$};
    \draw[->] (tree-2-2) -- (tree-3-3) node [midway,below] {$(1-p)p$};
    \draw[->] (tree-4-2) -- (tree-3-3) node [midway,above] {$(1-p)p$};
    \draw[->] (tree-4-2) -- (tree-5-3) node [midway,below] {$(1-p)^2$};
  \end{tikzpicture}
```
<subcaption><small>Fuente: Elaboración propia, basado en código de user71804 https://tex.stackexchange.com/questions/227414/draw-5-period-binomial-tree</small></subcaption>


Partiendo de esto, lo que se ha hecho para la implementación de estos árboles y basado en los precios de las acciones y sus probabilidades, ha sido desarrollar un método de recursivo para el cálculo de un árbol binomial de precios, el cual se ha desarrollado en una matriz basada en las ecuaciones para el caso de los inversores con riesgo neutral. La volatilidad obtenida a partir de los precios históricos con los que se contaba y la cantidad pagada de dividendo de forma anual. 

Es importante destacar que se trabaja de forma anualizada de tal forma que si el tiempo para el vencimiento de una opción es de tres meses entonces $t_f=0.25$, seis meses $t_f=0.5$ y un año $t_f=1$. El riesgo neutral se calcula a través de una interpolación de las tasas (anualizadas) con las que se cuenta mediante el modelo de _Svensson_, a partir del cual se obtienen los parámetros que pueden ser usados para calcular $y(t)$, y así encontrar el factor de descuento

\[
e^{-y(t_f)h_n}
\]

Además, se tiene que las acciones de Holcim Costa Rica S.A. pagan dividendos en fechas establecidas. Sin embargo, estos no se basan en una composición continua de pagos de los mismos y se establecen en un rango de fechas, se conviene que, salvo la opción tenga vencimiento en los rangos de fechas establecidos para el pago de los dividendos $q=0$.


En el caso de que la opción se establezca en una fecha donde se pagan dividendos, el poseedor de la acción a la fecha es el que tiene el derecho al dividendo. 
Basado en los registros con los que se cuenta de la empresa se supone que los siguientes pagos de dividendos serán oficializados, tanto el monto como la fecha de pago se harán el 21 de diciembre de 2021 y el 22 de abril del 2022.

Además, la volatilidad ha sido calculada de forma semanal, ya que eran los datos con mayor recurrencia con los que se contaba, con los cuales se calcula la volatilidad anual


\[
\sqrt{52}\cdot\sigma_{\text{Semanal}}=\sigma_{\text{Anual}}
\]

Donde $\sigma_{\text{Semanal}}$ es calculado mediante los rendimientos logarítmicos en cada semana y la función de desviación _sd_ de $\mathbf{R}$. La cantidad de pasos hasta el vencimiento de la opción se establecieron de acuerdo con la cantidad de días entre el día que la opción sería escrita y la fecha de vencimiento de la misma, teniendo en cuenta los días no bursátiles según la Bolsa Nacional de Valores de Costa Rica.

Una vez con los datos necesarios, se parte de una matriz (sin valores), la cual está basada en la cantidad de pasos que se querían hacer y en dejar espacios entre los precios, ya que quedará de una forma más clara cómo aumenta, así toma las dimensiones $n+1\times2n+1$ y se coloca el precio $S_0$ en la columna $n+1$ y fila $1$. 

A partir de esto, se recorre la matriz buscando valores numéricos, para continuar agregando los valores a la matriz, es decir, se nota que en la posición que corresponde a la fila 1 con la columna $n+1$, se encuentra el valor $S_0$. Entonces basado en el valor $u$ y $d$, se coloca en la posición fila 2 columna $n$ el valor de $S_0d$ y en el caso de la fila 2 columna $n+2$ el valor de $S_0u$. Posterior a esto, se recorre la segunda fila y basado en el precio $S_0d$ ubicado en la posición anteriormente establecida, se coloca $S_0d^2$ en la fila 3 columna $n-1$ y, de forma análoga, $S_0ud$ en la fila 3 columna $n+1$. Para el caso de $S_0u$ en la posición establecida anteriormente, se coloca $S_0u^2$ en la fila 3 columna $n+3$. El caso de $S_0du$ en la fila 3 columna $n+1$, y se siguen recorriendo las filas de forma recursiva hasta la fila $n$, ya que al llegar a la $n+1$ ya no habrá más pasos que hacer. Posterior a esto, para mostrarla en el trabajo, se ha hecho un espejo de derecha a izquierda de la matriz y se transpuso para obtener la forma querida que son los pasos de izquierda a derecha. Se trabajó de forma vertical por comodidad.

Para calcular de forma recursiva el precio de la opción de compra, se creo una matriz de las mismas dimensiones que la anterior y a partir de esto, aprovechando la forma en que trabaja $\mathbf{R}$, se le resta a toda la fila $n+1$ de la matriz de los precios el valor de ejercicio $K$. Si el valor obtenido es mayor que 0, entonces este valor es el que se deja en el vector que se genera. En otro caso, se coloca el valor de 0 en esa posición del vector, este vector se introduce en la matriz vacía de los precios de las opciones de compra justamente en la fila $n+1$. 

Usando los valores $p$ y la tasa de curva soberana ajustada para cada paso y ligada a la fecha de maduración de la opción de compra, se comienza a rellenar la matriz. Note que a pesar de que en la fila $n+1$ se introdujo el vector anteriormente descrito, hay posiciones que no tienen elementos, ya que así se había construido la matriz de los precios. 

La forma de realizar este procedimiento es empezar en la fila $n+1$ y se consulta si la entrada de la fila $n+1$ tiene un valor numérico, esto para los valores de columna desde $1$ hasta $2n-1$, se hace hasta esta entrada, ya que una vez encontrado un valor numérico en la entrada $j$, se toma este valor y se multiplica por $1-p$. A lo obtenido se le suma el valor de la entrada $j+2$, que se multiplica por le valor $p$. Ya con esto se multiplica por el factor de descuento, y se coloca el valor obtenido en la fila $n$ en la columna $j+1$. Ahora para la fila $n$ se repite el proceso y así hasta llegar a rellenar la fila 1 con el valor actual de la opción.

Para el caso de la opción de venta, se puede emplear la función del árbol de la opción de compra, basta introducir el precio de ejercicio y el precio de actual de forma negativa.

Ahora también se ha desarrollado una función para efectuar tanto el cálculo de la opción de compra como la opción de venta, basada en la misma idea recursiva mostrada en el marco teórico. Esta puede ser de mayor utilidad, ya que retorna el valor de forma directa.

# Resultados

Se presentan los resultados obtenidos al aplicar el modelo para el precio de las opciones a 3, 6 meses y 1 año, empleando como precio de ejercicio el precio del 17 de junio del 2021.

```{r}
## La cantidad de días hábiles se va tomar como la cantidad de pasos que se van a hacer
## Recuerde que las opciones que se van a calcular son para el tipo europeo
### Cantidad de días bursátiles a partir del 30 de junio hasta el primero de octubre del 2021
### En este caso se usará como tasa libre de riesgo la brindada por la curva soberana, note que para que no hayan oportunidades de riesgo se debería cumplir d<1+r<u donde r es la tasa libre de riesgo de un periodo

funcionFines<-function(a,b){
numeroDeDias<-seq(as.Date(a,format="%d/%m/%Y"),as.Date(b,format="%d/%m/%Y"),by="days")
numeroDeDias<-numeroDeDias[(wday(as.Date(numeroDeDias,format="%Y-%m-%d")))<6]
return(length(numeroDeDias))
}



nTrimestral<-funcionFines("17/06/2021","18/09/2021")-length((tablaConDiaNB%>%filter(Fecha>=as.Date("17/06/2021",format="%d/%m/%Y")& Fecha<as.Date("18/09/2021",format="%d/%m/%Y")))$Fecha)
### Cantidad de días bursátiles a partir del 30 de junio hasta el dos de enero del 2021 (Teniendo en cuenta del 1 de enero) 


nSemestral<-funcionFines("17/06/2021","18/12/2021")-length((tablaConDiaNB%>%filter(Fecha>=as.Date("01/10/2021",format="%d/%m/%Y") & Fecha<as.Date("18/12/2021",format="%d/%m/%Y")))$Fecha)
### Cantidad de días bursátiles a partir del 30 de junio hasta el 30 de junio del 2021 (tomando como punto de referencia los días no bursátiles del presente año)

nAnual<-funcionFines("17/06/2021","18/06/2022")-length((tablaConDiaNB%>%filter(Fecha>=as.Date("17/06/2021",format="%d/%m/%Y")))$Fecha)-4
### Anteriormente se determinó la volatilidad diaria entonces se usará esta ya que se está usando la cantidad días como la cantidad de pasos
sigma<-volatilidad_anual ### A la espera
q<-0 ## A la espera de dividendos anuales
### Se trabaja de forma anualizada por lo que se tiene que los valores hn correspondientes son
## Tres meses equivalen a un cuarto del año
hnTrimetral<-0.25/as.numeric(nTrimestral)
## Seis meses equivalen medio año por lo que
hnSemestral<-0.5/as.numeric(nSemestral)
## Un año equivale a 1
hnAnual<-1/as.numeric(nAnual)
### El precio de ejercicio con el que vamos a escribir las opciones es el último con el que se cuenta
K<-Precios$Último[1]

## Se procede a calcular los valores de u,p, a con la función programa anteriomente y haciendo uso del modelo de Svensson con los parámetros calculados y la volatilidad calculada anteriormente
valoresTrimestral<-parametros(K,K,nTrimestral,hnTrimetral,sigma,svensson(parametrosModelo,1/4),q)
valoresSemestral<-parametros(K,K,nSemestral,hnTrimetral,sigma,svensson(parametrosModelo,1/2),q)
valoresAnual<-parametros(K,K,nAnual,hnTrimetral,sigma,svensson(parametrosModelo,1),q)
### Opciones put y call para el caso de trimestral
precioOpcionCTrimestral<-precioC(K,K,nTrimestral,hnTrimetral,sigma,svensson(parametrosModelo,1/4),q)
precioOpcionPTrimestral<-precioP(K,K,nTrimestral,hnTrimetral,sigma,svensson(parametrosModelo,1/4),q)
### Opciones put y call para el  caso semestral
precioOpcionCSemestral<-precioC(K,K,nSemestral,hnSemestral,sigma,svensson(parametrosModelo,1/2),q)
precioOpcionPSemestral<-precioP(K,K,nSemestral,hnSemestral,sigma,svensson(parametrosModelo,1/2),q)
### Opciones put y call para el caso anual
precioOpcionCAnual<-precioC(K,K,nAnual,hnAnual,sigma,svensson(parametrosModelo,1),q)
precioOpcionPAnual<-precioP(K,K,nAnual,hnAnual,sigma,svensson(parametrosModelo,1),q)
resultados<-data.frame(Tiempo=rep(c("Tres meses","Seis Meses","Un año"),2),"Opción"=c(rep('Compra',3),rep('Venta',3)),"Precio"=c(precioOpcionCTrimestral,precioOpcionCSemestral,precioOpcionCAnual,precioOpcionPTrimestral,precioOpcionPSemestral,precioOpcionPAnual))
```


Primero los valores obtenidos para $a$, $p$ y $u$ se presentan en la siguiente tabla:


```{r}
### Se procede a colocar en una tabla los valores obtenido para a, p y u entonces se tiene
tablaValores<-data.frame('Tiempo'=c('Tres meses','Seis meses','Un año'),'a'=c(valoresTrimestral[1],valoresSemestral[1],valoresAnual[1]),'p'=c(valoresTrimestral[2],valoresSemestral[2],valoresAnual[2]),'u'=c(valoresTrimestral[3],valoresSemestral[3],valoresAnual[3]))
tablaValores%>%kbl(col.names = c('Tiempo','$a$','$p$','u'),caption="<center><strong>Tabla 6: Resultados de $a,p$ y $u$ </strong></center>")%>%kable_material()
```
<subcaption><small> Fuente: Elaboración propia, datos de Investing.com, Holcim Costa Rica S.A. y BCCR</small></subcaption>

A continuación se presenta una tabla en la que se presenta la matriz, que representa el árbol binomial para el caso de los precios a tres meses con `r nTrimestral` pasos.


<caption><center><strong>Tabla 7: Árbol binomial de precios de activo subyacente a tres meses </strong></center></caption>
```{r}
arbolrTri<-(arbolBinarioM(nTrimestral,hnTrimetral,sigma,K))
arbolrTri[is.na(arbolrTri)]=""
arbolrTri<-t(arbolrTri[,rev(seq_len(ncol(arbolrTri)))])
arbolrTri%>%kbl()%>%kable_material()%>%kable_styling(full_width = F)%>%scroll_box(width = "100%",height = "500px")
```
<subcaption><small> Fuente: Elaboración propia, datos de Investing.com, Holcim Costa Rica S.A. y BCCR</small></subcaption>



Basado en la tabla 7 (árbol), se presenta una tabla donde se encuentra la matriz de los posibles precios en cada uno de los pasos de una opción de compra a tres meses.


<caption><center><strong>Tabla 8: Árbol binomial de precios opción de compra a tres meses </strong></center></caption>
```{r}
arbolCTri<-(arbolBinarioC(nTrimestral,hnTrimetral,sigma,K,svensson(parametrosModelo,1/4),valoresTrimestral[2],K,q))
arbolCTri[is.na(arbolCTri)]=""
arbolCTri<-t(arbolCTri[,rev(seq_len(ncol(arbolCTri)))])
arbolCTri%>%kbl()%>%kable_material()%>%kable_styling(full_width = F)%>%scroll_box(width = "100%",height = "500px")
```
<subcaption><small> Fuente: Elaboración propia, datos de Investing.com, Holcim Costa Rica S.A. y BCCR</small></subcaption>


Y de forma similar a la tabla 8 se presenta el caso, pero de una opción de venta igualmente a tres meses.

<caption><center><strong>Tabla 7: Árbol binomial de precios de activo subyacente a tres meses </strong></center></caption>
```{r}
arbolPTri<-(arbolBinarioC(nTrimestral,hnTrimetral,sigma,-K,svensson(parametrosModelo,1/4),valoresTrimestral[2],-K,q))
arbolPTri[is.na(arbolPTri)]=""
arbolPTri<-t(arbolPTri[,rev(seq_len(ncol(arbolPTri)))])
arbolPTri%>%kbl()%>%kable_material()%>%kable_styling(full_width = F)%>%scroll_box(width = "100%",height = "500px")
```
<subcaption><small> Fuente: Elaboración propia, datos de Investing.com, Holcim Costa Rica S.A. y BCCR</small></subcaption>


Se presentan los precios de las opciones a tres meses, seis meses y un año se presentan en la siguiente.


```{r}
resultados%>%kbl(col.names = c("Tiempo","Opción","Precio"),caption="<center><strong>Tabla 9: Precio de las distintas opciones</strong></center>")%>%kable_material()
```
<subcaption><small> Fuente: Elaboración propia, datos de Investing.com, Holcim Costa Rica S.A. y BCCR</small></subcaption>

# Conclusión


# Bilibliografía

<style type="text/css" media="screen">
  .apa,.apa ul,.apa ol,.apa dl,.ref-apa,.ref-apa ul,.ref-apa ol,.ref-apa dl,.apa-ref,.apa-ref ul,.apa-ref ol,.apa-ref dl,.refapa,.refapa ul,.refapa ol,.refapa dl,.aparef,.aparef ul,.aparef ol,.aparef dl{padding-left:0;margin-left:0;}
  .apa li,.ref-apa li,.refapa li,.apa-ref li,.aparef li{list-style-type:none;}
  .apa p,.apa li,.apa dd,.ref-apa p,.ref-apa li,.ref-apa dd,.refapa p,.refapa li,.refapa dd,.apa-ref p,.apa-ref li,.apa-ref dd,.aparef p,.aparef li,.aparef dd{margin-left:2em;text-indent:-2em;margin-top:1em;margin-bottom:1em;}
</style>

<div class="ref-apa" markdown="1">
Banco Central de Costa Rica (30 de junio del 2021). https://gee.bccr.fi.cr/indicadoreseconomicos/Cuadros/frmVerCatCuadro.aspx?idioma=1&CodCuadro=%202786

Banco Central de Costa Rica (s.f.). _Nota metológica. Curva de Rendimeinto de Costa Rica_. Recuperado de https://bit.ly/3jNt0eP

Banco Central de Costa Rica (s.f.). _Aspectos metológicos del cálculo de la curva de rendimientos soberana en colones_. https://bit.ly/3hnLFwp

Boudreault, M., & Renaud, J. F. (2019). _Actuarial Finance: Derivatives, Quantitative Models and Risk Management_. John Wiley & Sons.

Cox, J. C., Ross, S. A., & Rubinstein, M. (1979). Option pricing: A simplified approach. _Journal of financial Economics_, 7 _(3)_, 229-263.

Evans, M. and Rosenthal, J. (2010)._Probability and statistics. The science of uncertainty_. Freeman, 2da. edición.

Holcim (Costa Rica) S.A. (30 de junio del 2021). http://www.holcimchampions.com/accionistas/

Investing.com (30 de junio del 2021). https://es.investing.com/equities/holcim-de-costa-rica-s.a.-historical-data

Mascareñas, J. (2000). El Método binomial de valoración de opciones. Universidad Complutense de Madrid. 
Recuperado de http://www.gacetafinanciera.com/TEORIARIESGO/VALOREOPCIONES.pdf

Petters, A. O., & Dong, X. (2016). _An introduction to mathematical finance with applications_. Springer.

Ruppert, D. and Matteson, D. (2015). _Statistics and data analysis for financial engineering_, volumen 13. Springer

Solano, H. (2019). _Fiscalía allana bufete, Holcim y Productos de Concreto en investigación contra abogado_. Recuperado de https://www.nacion.com/sucesos/judiciales/fiscalia-allana-bufete-holcim-y-productos-de/YILACK2KSZFZ7ISZ3UYAG4OAVE/story/ 

</div>


