---
title: "Laboratorio 3"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: kate
    toc_depth: 3
    embed_fonts: true
    use_bookdown: false
    pandoc_args: Null 
---


```{r setup, include=FALSE}
library(knitr)
library(rmdformats)
library(kableExtra)
library(tidyverse)
library(readxl)



##Importante instalar lo que sigue acontinuacion, que está comentado
## Global options
options(max.print="75")
opts_chunk$set(echo=FALSE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

# Instrucciones


- El laboratorio consiste en un trabajo en equipo en el cual se implementen los conceptos desarrollados en clase y la profundización de los mismos. 
- El objetivo general es: Aplicar el método de Árbol binomial en instrumentos financieros de renta variable. 
- Debe desarrollar el modelo para el cálculo, con una programación eficiente y ordenada en RStudio que incluya lo siguiente: 
    - El modelo para el árbol binomial. 
    - El modelo para la valoración del derivado.
    - Un análisis de resultados obtenidos. 
    - Debe entregar el código que incluya una breve explicación de la funcionalidad del mismo.
    
- En trabajo escrito RMarkdown deberá incluir lo siguiente: 
    - Párrafo introductorio donde comenta el trabajo realizado. 
    - Marco teórico que fundamente el laboratorio, según lo visto en clase y profundizaciones de contenidos.
    - Metodología utilizada en el laboratorio. 
    - Una sección (o capítulo) de descripción de los datos históricos a utilizar, donde se describan las principales características de las variables relevantes. 
    - Una sección (o capítulo)  con el análisis del árbol binomial y su implementación para valorar un derivado financiero. 
    - Una sección (o capítulo)  que incluya resultados. 
    - Una sección (o capítulo)  en el cual realice conclusiones
    - Refencias bibliográficas.
- Para llevar a cabo el ejercicio, se le proponen las siguientes preguntas de investigación. Elija la que más le guste o bien, puede proponer una nueva pregunta de investigación.
    
    
    
    
# Sugerencia 1

¿Cómo el precio de las acciones de alguna empresa nacional observadas con cierta frecuencia se pueden utilizar para determinar el precio que tendrá una opción de venta o de compra en el futuro, si el subyacente es la acción observada?

* Buscar datos el activo subyacente. 
* Implementar el modelo de árbol binomial para predecir los precios futuros del subyacente.
* Utilizar la modelación anterior para determinar el precio que debe tener la opción de venta (o compra), utilizando un modelo adecuado de valoración.

# Sugerencia 2

¿Cómo afecta la posibilidad de incumplimiento a la opción de compra de un bono a 10 años de la Compañía ABC que es exigible en cualquier momento después de cinco años? El modelo crediticio y la opción no son separables porque se impactan entre sí. 

# Sugerencia 3

¿Cómo utilizar el árbol binomial para estimar un rango para la inflación a seis meses en Costa Rica?






# Marco teórico

En primera instancia se mostrará la notación que se mantendrá a los largo del trabajo.
```{r}
notacion<-c("$t_j$","$t_0$","$t_f$","$\\tau$","$n$","$h_n$","$S(t_j),S_{j}$","$p_n$","$1-p_n$","$u_n$","$d_n$","$q$", "$D(t_j,t_j)=qS_{j-1}h_n$")
significado<-c("Tiempo $j$","Tiempo inicial","Tiempo final","$t_f-t_0$","Cantidad de periodos en el que se divide $[t_f,t_0]$","Largo de cada periodo en el se divide $[t_f,t_0]$, espeficamente el largo es $\\frac{\\tau}{n}$","Precio de la acci\'on en el tiempo j","Probabilidad de que el precio de la acción aumente de un periodo a otro.","Probabilidad de que el precio de la acción disminuya de un periodo a otro.","Proporción en que aumenta el precio del activo de un periodo a otro","Proporción en que disminuye el precio de la activo de un periodo a otro","Proporcion de dividendo","Monto pagado de dividen el momento $j$")
tablaNotacion<-data.frame(Notacion=notacion,Significado=significado)
tablaNotacion%>%kbl()%>%kable_material()
```
Existen distintos métodos para la valoración de opciones entre ellos los que se basan en métodos numéricos como lo expone Marín (2009) existen el de Monte Carlo, diferencias finitas, árboles binomiales y trinomiales. A lo largo de este trabajo se trabajará la valoración de las opciones bajo el modelo de árboles binomiales. Los modelos básados en métodos numéricos a diferencia de otros poseen la ventaja de de que su implementación computacionalmente es más simple y eficiente que el desarrollo de soluciones analíticas para la valoración de las opciones basado en el comportamiento del activo subyacente.

Se procede a explicar lo que son los árboles binomiales, así como su construcción. De acuerdo al texto _An introduction to Mathematical Finance with Application_, los árboles binomiales muestran los posibles precios futuros de un activo basado en el conocimiento del precio actual del activo subyacente. Para este modelo se parte de un intervalo $[t_0,t_f]$, este intervalo es subdivido en $n$ subintervalos del mismo largo llamados pasos de tiempo, así se obtienen los intervalos $[t_0,t_1],[t_1,t_2],...,[t_{n-1},t_{n}]$ donde
\[
0\leq t_0,\quad t_1=t_0+h_n,\quad t_2=t_0+2h_n,\quad...,\quad t_{n-1}=t_0+(n-1)h_n,\quad t_n=t_0+nh_n=t_f
\]
Gráficamente un árbol binomial.
Para poder trabajar con árboles binomiales es necesario hacer algunas asunciones.

## Asunciones para trabajar con árboles binomiales
* Propiedad de recombinación: Si el precio aumenta en un paso y en el siguiente disminuye entonces se obtiene el precio que se tenía antes de que se hiceran ambos pasos, esto es $S_ju_nd_n=S_jd_nu_n$ con $j\leq n-2$. A partir de esta propiedad se obtiene que la cantidad posible de precios que tiene el activo en el tiempo $t_n$. Se cumple que la forma en que aumenta el precio de una forma totalmente aleatoria cumpliendo

\[
S(t_j)=S_0u_n^{N_{u,j}}u_n^{1-N_{u,j}}
\]

Donde $N_{u,j}$ es la variable aletoria cantidad de aumentos hasta el periodo $j$ partiendo del periodo $0$.

* Retorno bruto, ganancia de capital y retorno logaritmico: Para cada paso de tiempo $[t_{j-1},t_{j}]$, donde $j=1,\dots,n$, el aumento o disminución del precio del activo es retorno bruto $\frac{S_j}{S_{j-1}}$. Cada uno de estos retornos es asumido independiente e identicamente distribuido (i.i.d), de hecho se asumen variables aleatorias con distribución de Bernoulli. 

\[
\frac{S_j}{S_{j-1}}=\begin{cases}
u_n & \text{con probabilidad $p_n$}\\
d_n & \text{con probabilidad $1-p_n$}
\end{cases}
\]

La ganancias de capital son igual a $\mathbf{R_j}=\frac{S_j}{S_{j-1}}$ con $j=1,...,n$, que también son variables aleatorias i.i.d y son independientes. así mismo los retornos logarítmicos que son $\frac{\ln S_j}{\ln S_{j-1}}$ con $j=1,...,n$.

\[
\ln\frac{S_j}{S_{j-1}}=\begin{cases}
\ln{u_n} & \text{con probabilidad $p_n$}\\
\ln{d_n} & \text{con probabilidad $1-p_n$}
\end{cases}
\]
El retorno logarítmico entre el periodo $t_0$ y $t_f$ es igual a
\[
\ln\frac{S_j}{S_{j-1}}=\ln\frac{S_1}{S_{0}}+\ln\frac{S_2}{S_{1}}+\cdots +\ln\frac{S_n}{S_{n-1}}
\] 
* La tripleta $p_n,u_n,d_n$: Estas cantidades dependen del tamaño $h_n$, de paso de tiempo.
* Medida de la probabilidad: La probabilidad de que un camino de precios ocurra es obtenido mediante la multiplicación de las probabilidades a lo largo del camino. Esto es si $N_u$ es la variable aleatoria número de aumentos de la seguridad desde $t_0$ hasta $t_f$, está variables binomial. Si $\Omega_n$ es el espacio muestral los caminos de precios desde $t_f$ hasta $t_f$ entonces si $\omega_n$ entonces

\[
\mathbb{P}(w_n)=p_n^{N_u(\omega_n)}(1-p_n)^{N_u(\omega_n)}
\]

Ahora bajo el supuesto de que de los caminos de precio son independientes entonces se cumple que la probabilidad de tener un determinado precio en el momento $t_f$

\[
\mathbb{P}(S(t_n)=S_0)=\binom{n}{i}p^{i}(1-p_n)^{n-i}
\]

Notese que se a trabajado hasta el momento de manera discreta.
* Se supone el activo paga un dividendo constante, continuo y proporcional: De tal forma que

\[
D(t_{j-1},t_{j})=qS_{j-1}h_n, \quad j=1,2,..,n
\]

* La tasa de retorno total es: Por paso de tiempo 

\[
R(t_{j-1},t_j)=\frac{S_j-S_{j-1}+D(t_{j-1},t_{j})}{S_{j-1}}=\mathbf{R_j}+qh_n
\]
Con estas asunciones, se procede a exponer el modelo de Cox-Ross-Rubinstein (CRR), el cuál puede ser empleado para valorar las opciones de compra y de venta.

## Árbol de Cox-Ross-Rubinstein 

El árbol binomial CRR cumple todas las suposiciones que se hicieron en la actrior subsección, este permite determinar $u_n,d_n$ y $p_n$ en términos de periodos de largo $h_n$ para un $n$ suficientemente largo.

Para este modelo hace falta tomar algunas suposiciones más a parte de las anteriores.

* Casi seguramente caminos muestrales de precios continuos: Los caminos muestrales de precios son continuos cuando $n\to\infty$.
* Condición de recombinación: $u_nd_n=1$
* Retornos esperados: Los retornos esperado convergen a una constante $m$

\[
\frac{\mathbb{E}(t_0,t_1)}{h_n}\to m, \qquad n\to \infty
\]

Ahora de esto se puede notar que también

\[
\frac{\mathbb{E}(\mathbf{R_1})}{h_n}=\frac{\mathbb{E}(R(t_0,t_1))}{h_n}\to m-q
\]

$m$ y $q$ se asumen dados.

* La constante $\sigma$: Si se define $\sigma^2_n$ la varianza de los retornos logarítmicos por cada paso entonces

\[
\sigma_n^2=\frac{1}{h_n}\text{Var}\left(\ln\frac{S_1}{S_0}\right)
\]

Donde la varianza por la forma en que se distribuyen los retornos logarítmicos entonces

\[
\sigma_n^2h_n=p_n(1-p_n)\left[\ln\frac{S_1}{S_0}\right]
\]

Como los retornos logaritmicos están i.i.d entonces se cumple que la varianza del retorno en el intervalo $[t_0,t_f]$ es $n$ veces la varianza de cada paso de tiempo
\[
\text{Var}\left(ln\frac{S_n}{S_0}\right)=n\text{Var}\left(\frac{S_1}{S_0}\right)
\]
Se asume que $\sigma^2_n\to \sigma_2>0$ cuando $n\to \infty$. Esto se le llama la volatilidad del precio de la seguridad. Ahora los inversores pueden ser más o menos aversos al riesgo, en la siguiente subsección se explora el caso de los inversores con riesgo neutral.


## Inversores con riesgo neutral

Para el caso de los inversores con riesgo neutral se cumplen las siguientes ecuaciones para $n$ lo suficientemente grande.
\[
u_n\approx e^{\sigma\sqrt{h_n}},\quad u_n\approx e^{\sigma\sqrt{h_n}}
\]






























# Analisis de datos

```{r}
Precios<- read_csv("Datos históricos INCa.csv")
Curva_soberana <- read_excel("Curva soberana.xlsx")
Precios$Fecha<-as.Date(Precios$Fecha,format="%d.%m.%Y")
Curva_soberana<-Curva_soberana[2:12]




Precios%>%ggplot(aes(x=Fecha, y =Último))+
  geom_line()+
  labs(y = "Precios",x = "Tiempo" ,caption = "Fuente: Elaboración propia, con datos del ....")+theme_minimal()+theme(legend.position="bottom",plot.caption=element_text(hjust=0))







```

Se va a trabajar con los datos de la curva soberana obtenidos de la página del Banco Central de Costa Rica, los mismos son establecidos para la semana del 23 de junio del año 2021 al 29 de junio de año 2021. Se tiene que las observaciones son:

```{r}
Curva_soberana%>%kbl()%>%kable_material()
```

Aplicando el modelo de Nelson y Siegel, se puede obtener una curva continua, la cual se representa en el siguiente grafico:
```{r}
#### Se calculan los parametros
Curva_soberana


# t<-c(0,0,0,0.05)
# parametrosCurva<-fitNS(t,c(1,1*30,3*30,6*30,9*30,1*360,2*360,3*360,5*360,7*360,10*360),Curva_soberana$,1000,datosMaximo$CuponSemestral)
```





Marco teórico, curva soberana


Metodologia, periodo y que datos
Conclusiones

