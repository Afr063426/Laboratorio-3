---
title: "Laboratorio 3"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: kate
    toc_depth: 3
    embed_fonts: true
    use_bookdown: false
    pandoc_args: Null 
---


```{r setup, include=FALSE}
library(knitr)
library(rmdformats)
library(kableExtra)
library(tidyverse)
library(readxl)

library(ggplot2)

##install.packages('magick') para dibujos tikz
##install.packages('pdftools')
#tinytex::install_tinytex()
library(pdftools)
library(magick)
## Global options
options(max.print="75")
opts_chunk$set(echo=FALSE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

```{r}
##Se cargan los datos que se van a utilizar y se preparan para la utilización 

Precios<-read_excel("Datos históricos INCa.xlsx")
Precios$Fecha<-as.Date(Precios$Fecha,format="%d.%m.%Y")

Precios$Apertura<-gsub(",",".",Precios$Apertura )
Precios$Máximo<-gsub(",",".",Precios$Máximo )
Precios$Mínimo<-gsub(",",".",Precios$Mínimo )
Precios$Último<-gsub(",",".",Precios$Último )
Precios$`% var.`<-gsub(",",".",Precios$`% var.` )

Precios$Apertura<-as.numeric(Precios$Apertura)
Precios$Máximo<-as.numeric(Precios$Máximo)
Precios$Mínimo<-as.numeric(Precios$Mínimo)
Precios$Último<-as.numeric(Precios$Último)


Montos <- read_excel("Montos.xlsx")
Montos$FechaDePago<-as.Date(Montos$FechaDePago,format="%Y.%m.%d")
Montos<-Montos[15:19,1:4]
## Primero se trabaja con las tasas elaboradas por el banco central de Costa Rica
### Estos eran las tasas vigentes de la semana del 23 de junio del 2021 hasta el 29 de junio del 2021
tasasBCCR<-read_xlsx("Curva soberana.xlsx")



### Primero se genera una tabla con los días no bursatiles en Costa Rica de acuerdo a la bolsa nacional de valores en el año 2021
fecha<-as.Date(c("01/01/2021","01/04/2021","02/04/2021","03/05/2021","26/07/2021","02/08/2021","13/09/2021","29/11/2021","25/12/2021","31/12/2021"),format="%d/%m/%Y")
descripcion<-c("Año Nuevo","Jueves Santo", "Viernes Santo","Día del Trabajador","Anexión del partido de Nicoya","Día de la Virgen de Los Ángeles","Independecia","Día de la Abolición del Ejercitos","Día de Navidad","Feriado Banco Central")
tablaConDiaNB<-data.frame(Fecha=fecha,Descripción=descripcion)
tablaKableConDiaNB<-tablaConDiaNB%>%kbl()%>%kable_material()



```



```{r}
### Se programarán en esta sección las mayoría de cuestiones necesarias para la elaboración
## del proyecto

### Primero se procede a programar la curva paramétrica del modelo de Svensson para interpolar
## la curva soberana basado en los datos que se tienen BCCR

### Modelo de Svensson programado como función
svensson<-function(beta,tiempo){
  beta[1]+beta[2]*((1-exp(-tiempo/beta[5]))/(tiempo/(beta[5])))+beta[3]*((1-exp(-tiempo/beta[5]))/(tiempo/beta[5])-exp(-tiempo/beta[5]))+beta[4]*((1-exp(-tiempo/beta[6]))/(tiempo/beta[6])-exp(-tiempo/beta[6]))
}
### Se procede a programar la función que mediante interpolación aproxima las tasas a partir de las
## con las que se cuenta


fitSvensson<-function(beta,tiempo,tasas){
  fn<-function(beta,tiempo,tasas){
    sum((tasas-svensson(beta,tiempo))^2) ### Suma de resta de cuadrados
  }
  optim(beta,   ### Se optimizan la suma de resta de cuadrados para tener el menor error posible
        fn,
        method = "L-BFGS-B",
        lower=rep(-20,6),
        upper = rep(-20,6)
        )
}


### Se procede a programar el árbol binomial, para este lo que se le introducirá a la función será el la volatilidad en el periodo junto con la cantidad de pasos que se quieren hacer y el largo de cada paso. La volatilidad, es determinada de forma separada. Se va hacer que la función retorne el árbol en forma de matriz, si el paso a parece a la derecha es el aumento si a parece a la izquierda del padre es porque disminuye, tambien se le pasa el precio S_0

arbolBinarioM<-function(n,hn,volatilidad,S_0){
  u<-exp(volatilidad*sqrt(hn))
  d<-exp(-volatilidad*sqrt(hn))
  ### La cantidad de columnas de la matriz es n+1 ya que hay n+1 precios posibles en el paso final
  ### La cantidad de filas van a ser n+1 ya que son los n pasos y el precio incial
  arbol<-matrix(nrow=n+1,ncol = 2*n+1)
  arbol[1,n+1]<-S_0
  for(i in 1:n){
    for(j in 1:(2*n+1)){
      if(!is.na(arbol[i,j])){
        arbol[i+1,j-1]<-arbol[i,j]*d
        arbol[i+1,j+1]<-arbol[i,j]*u
      }
    }
  }
  return(arbol)
}

### Función de parámetros en esta función se programará la probabilidad de aumentos, el aumento por paso, el valor mínimo de aumentos que debe haber para que la opción se ejecute
## K es el precio de ejercicio
## S_0 el precio actual
## n es el numero de pasos
## hn el largo de los pasos
## La volatilidad en el periodo es la varianza calculada mediante los datos que se tengan
## r es la tasa libre de riesgo en el periodo
## q es el porcentaje de dividendo que se paga sobre la acción
## Estas variables con esta notación se mantiene para las siguientes funciones
parametros<-function(K,S_0,n,hn,volatilidad,r,q){
  u<-exp(volatilidad*sqrt(hn)) ## Este es el aumento en cada paso
  p<-(exp((r-q)*hn)-d)/(u-d) ## Esta es la probabilidad del aumento
  a<-ceiling(K/(S_0*d^n*log(u^2)))  ## Esta es la cantidad minima de aumentos
  return(c(a,p,u))
}



### Se procede a programar la forma en que se calculan los precios de las opciones, caso call europea
precioC<-function(K,S_0,n,hn,volatilidad,r,q,t,d){
  parametros<-parametros(K,S_0,n,hn,volatilidad,(1+r)^d-1,q)
  sum(choose(n,c(parametros[1]:n))*parametros[2]^(c(parametros[1]:n))*(1-parametros[2])^(n-c(parametros[1]:n))*parametros[3]^(c(parametros[1]:n))*(1/parametros[3])^(n-(c(parametros[1]:n)))*S_0-K)/(1+r)^(t) ### Formula para precio de de las opciones de compra
}


### De forma análoga se programa el precio de una put option europea
precioP<-function(K,S_0,n,hn,volatilidad,r,q){
  parametros<-parametros(K,S_0,n,hn,volatilidad,r,q)
  sum(choose(n,c(0:(parametros[1]-1)))*parametros[2]^(c(0:(parametros[1]-1)))*(1-parametros[2])^(n-c(0:(parametros[1]-1)))*parametros[3]^(c(0:(parametros[1]-1)))*(1/parametros[3])^(n-c(0:(parametros[1]-1)))*S_0-K)### Formula para precio de de las opciones de venta
}
```





# Instrucciones


- El laboratorio consiste en un trabajo en equipo en el cual se implementen los conceptos desarrollados en clase y la profundización de los mismos. 
- El objetivo general es: Aplicar el método de Árbol binomial en instrumentos financieros de renta variable. 
- Debe desarrollar el modelo para el cálculo, con una programación eficiente y ordenada en RStudio que incluya lo siguiente: 
    - El modelo para el árbol binomial. 
    - El modelo para la valoración del derivado.
    - Un análisis de resultados obtenidos. 
    - Debe entregar el código que incluya una breve explicación de la funcionalidad del mismo.
    
- En trabajo escrito RMarkdown deberá incluir lo siguiente: 
    - Párrafo introductorio donde comenta el trabajo realizado. 
    - Marco teórico que fundamente el laboratorio, según lo visto en clase y profundizaciones de contenidos.
    - Metodología utilizada en el laboratorio. 
    - Una sección (o capítulo) de descripción de los datos históricos a utilizar, donde se describan las principales características de las variables relevantes. 
    - Una sección (o capítulo)  con el análisis del árbol binomial y su implementación para valorar un derivado financiero. 
    - Una sección (o capítulo)  que incluya resultados. 
    - Una sección (o capítulo)  en el cual realice conclusiones
    - Refencias bibliográficas.
- Para llevar a cabo el ejercicio, se le proponen las siguientes preguntas de investigación. Elija la que más le guste o bien, puede proponer una nueva pregunta de investigación.
    
    
    
    
# Sugerencia 1

¿Cómo el precio de las acciones de alguna empresa nacional observadas con cierta frecuencia se pueden utilizar para determinar el precio que tendrá una opción de venta o de compra en el futuro, si el subyacente es la acción observada?

* Buscar datos el activo subyacente. 
* Implementar el modelo de árbol binomial para predecir los precios futuros del subyacente.
* Utilizar la modelación anterior para determinar el precio que debe tener la opción de venta (o compra), utilizando un modelo adecuado de valoración.

# Sugerencia 2

¿Cómo afecta la posibilidad de incumplimiento a la opción de compra de un bono a 10 años de la Compañía ABC que es exigible en cualquier momento después de cinco años? El modelo crediticio y la opción no son separables porque se impactan entre sí. 

# Sugerencia 3

¿Cómo utilizar el árbol binomial para estimar un rango para la inflación a seis meses en Costa Rica?






# Marco teórico

En primera instancia se mostrará la notación que se mantendrá a los largo del trabajo.
```{r}
notacion<-c("$t_j$","$t_0$","$t_f$","$\\tau$","$n$","$h_n$","$S(t_j),S_{j}$","$p_n$","$1-p_n$","$u_n$","$d_n$","$q$", "$D(t_j,t_j)=qS_{j-1}h_n$","$r$","$K$","$C_j$")
significado<-c("Tiempo $j$","Tiempo inicial","Tiempo final","$t_f-t_0$","Cantidad de periodos en el que se divide $[t_f,t_0]$","Largo de cada periodo en el se divide $[t_f,t_0]$, espeficamente el largo es $\\frac{\\tau}{n}$","Precio de la acci\'on en el tiempo j","Probabilidad de que el precio de la acción aumente de un periodo a otro.","Probabilidad de que el precio de la acción disminuya de un periodo a otro.","Proporción en que aumenta el precio del activo de un periodo a otro","Proporción en que disminuye el precio de la activo de un periodo a otro","Proporcion de dividendo","Monto pagado de dividen el momento $j$","Tasa libre de riesgo","Precio de ejercicio","Precio de la opción en $j$")
tablaNotacion<-data.frame(Notacion=notacion,Significado=significado)
tablaNotacion%>%kbl()%>%kable_material()
```
Existen distintos métodos para la valoración de opciones entre ellos los que se basan en métodos numéricos como lo expone Marín (2009) existen el de Monte Carlo, diferencias finitas, árboles binomiales y trinomiales. A lo largo de este trabajo se trabajará la valoración de las opciones bajo el modelo de árboles binomiales. Los modelos básados en métodos numéricos a diferencia de otros poseen la ventaja de de que su implementación computacionalmente es más simple y eficiente que el desarrollo de soluciones analíticas para la valoración de las opciones basado en el comportamiento del activo subyacente.

Se procede a explicar lo que son los árboles binomiales, así como su construcción. De acuerdo al texto _An introduction to Mathematical Finance with Application_, los árboles binomiales muestran los posibles precios futuros de un activo basado en el conocimiento del precio actual del activo subyacente. Para este modelo se parte de un intervalo $[t_0,t_f]$, este intervalo es subdivido en $n$ subintervalos del mismo largo llamados pasos de tiempo, así se obtienen los intervalos $[t_0,t_1],[t_1,t_2],...,[t_{n-1},t_{n}]$ donde
\[
0\leq t_0,\quad t_1=t_0+h_n,\quad t_2=t_0+2h_n,\quad...,\quad t_{n-1}=t_0+(n-1)h_n,\quad t_n=t_0+nh_n=t_f
\]
Gráficamente un árbol binomial.


```{tikz, fig.cap = "Árbol Binomial de Dos Pasos", fig.ext = 'png'}
\usetikzlibrary{arrows}
\usetikzlibrary{trees}
\usetikzlibrary{matrix}
  \begin{tikzpicture}[>=stealth,sloped]
    \matrix (tree) [%
      matrix of nodes,
      minimum size=1cm,
      column sep=3.5cm,
      row sep=1cm,
    ]
    {
          &   & $S_0u_2^2$ \\
          & $S_0u_2$ &   \\
      $S_0$ &   & $S_0u_2d_2$ \\
          & $S_0d_2$ &   \\
          &   & $S_0d^2$ \\
    };
    \draw[->] (tree-3-1) -- (tree-2-2) node [midway,above] {$p$};
    \draw[->] (tree-3-1) -- (tree-4-2) node [midway,below] {$(1-p)$};
    \draw[->] (tree-2-2) -- (tree-1-3) node [midway,above] {$P^2$};
    \draw[->] (tree-2-2) -- (tree-3-3) node [midway,below] {$(1-p)p$};
    \draw[->] (tree-4-2) -- (tree-3-3) node [midway,above] {$(1-p)p$};
    \draw[->] (tree-4-2) -- (tree-5-3) node [midway,below] {$(1-p)^2$};
  \end{tikzpicture}
```
Para poder trabajar con árboles binomiales es necesario hacer algunas asunciones.

## Asunciones para trabajar con árboles binomiales
* Propiedad de recombinación: Si el precio aumenta en un paso y en el siguiente disminuye entonces se obtiene el precio que se tenía antes de que se hiceran ambos pasos, esto es $S_ju_nd_n=S_jd_nu_n$ con $j\leq n-2$. A partir de esta propiedad se obtiene que la cantidad posible de precios que tiene el activo en el tiempo $t_n$. Se cumple que la forma en que aumenta el precio de una forma totalmente aleatoria cumpliendo

\[
S(t_j)=S_0u_n^{N_{u,j}}u_n^{1-N_{u,j}}
\]

Donde $N_{u,j}$ es la variable aletoria cantidad de aumentos hasta el periodo $j$ partiendo del periodo $0$.

* Retorno bruto, ganancia de capital y retorno logaritmico: Para cada paso de tiempo $[t_{j-1},t_{j}]$, donde $j=1,\dots,n$, el aumento o disminución del precio del activo es el retorno bruto $\frac{S_j}{S_{j-1}}$. Cada uno de estos retornos es asumido independiente e identicamente distribuido (i.i.d.), de hecho se asumen variables aleatorias con distribución de Bernoulli. 

\[
\frac{S_j}{S_{j-1}}=\begin{cases}
u_n & \text{con probabilidad $p_n$}\\
d_n & \text{con probabilidad $1-p_n$}
\end{cases}
\]

La ganancias de capital son iguales a $\mathbf{R_j}=\frac{S_j}{S_{j-1}}-1$ con $j=1,...,n$, que también son variables aleatorias i.i.d. y son independientes.
Así mismo los retornos logarítmicos que son $\ln\frac{ S_j}{ S_{j-1}}$ con $j=1,...,n$.

\[
\ln\frac{S_j}{S_{j-1}}=\begin{cases}
\ln{u_n} & \text{con probabilidad $p_n$}\\
\ln{d_n} & \text{con probabilidad $1-p_n$}
\end{cases}
\]

* La tripleta $p_n,u_n,d_n$: Estas cantidades dependen del tamaño $h_n$, de paso de tiempo.

* Medida de la probabilidad: La probabilidad de que un camino de precios ocurra es obtenido mediante la multiplicación de las probabilidades a lo largo del camino. Esto es si $N_u$ es la variable aleatoria número de aumentos de la seguridad desde $t_0$ hasta $t_f$, está variables binomial. Si $\Omega_n$ es el espacio muestral los caminos de precios desde $t_f$ hasta $t_f$ entonces si $\omega_n$ entonces

\[
\mathbb{P}(w_n)=p_n^{N_u(\omega_n)}(1-p_n)^{N_u(\omega_n)}
\]

Ahora bajo el supuesto de que de los caminos de precio son independientes, entonces se cumple que la probabilidad de tener un determinado precio en el momento $t_f$

\[
\mathbb{P}(S(t_n)=S_0u_n^id_n^{n-i})=\binom{n}{i}p^{i}(1-p_n)^{n-i}
\]
Lo que muestra que los precios están distribuido de forma binomial.

* Se supone el activo paga un dividendo constante, continuo y proporcional al precio final de todo el tiempo $[t_0,t_f]$, de tal forma que

\[
D(t_{j-1},t_{j})=qS_{j-1}h_n, \quad j=1,2,..,n
\]

* La tasa de retorno total es: Por paso de tiempo 
\[
R(t_{j-1},t_j)=\frac{S_j-S_{j-1}+D(t_{j-1},t_{j})}{S_{j-1}}=\mathbf{R_j}+qh_n
\]
Con estas asunciones, se procede a exponer el modelo de Cox-Ross-Rubinstein (CRR), el cuál puede ser empleado para valorar las opciones de compra y de venta.

## Árbol de Cox-Ross-Rubinstein 

El árbol binomial CRR cumple todas las suposiciones que se hicieron en la anterior subsección, este permite determinar $u_n,d_n$ y $p_n$ en términos de periodos de largo $h_n$ para un $n$ suficientemente largo.

Para este modelo hace falta tomar algunas suposiciones más, aparte de las anteriores.

* Casi seguramente caminos muestrales de precios continuos: Los caminos muestrales de precios son continuos cuando $n\to\infty$.
* Retornos esperados: Los retornos esperado convergen a una constante $m$

\[
\frac{\mathbb{E}(R(t_0,t_1))}{h_n}\to m, \qquad n\to \infty
\]

Ahora se destaca que el retorno se puede obtener mediante la ganancia de capital y la proporción de dividendo $qh_j$ esto es $R(t_0,t_1)=\mathbf{R}_1+qh_n$ entonces
m
\[
\frac{\mathbb{E}(\mathbf{R_1})}{h_n}=\frac{\mathbb{E}(R(t_0,t_1)-q)}{h_n}\to m-q
\]

$m$ y $q$ se asumen dados y de tal forma que $m$ corresponde al retorno esperado.

* La constante $\mu_{RW}$:  Se define la $\mu_n$ como el retorno logaritmico de cada paso:

\[
\mu_n=\frac{1}{h_n}\mathbb{E}\left(\ln\left(\frac{S_1}{S_0}\right)\right)
\]
Que explícitamente por como se asumieron se distribuyen los retornos logarítmicos da como resultado
\[
\mu_nh_n=p_n\ln u_n+(1-p_n)\ln{d_n}
\]
Como los retornos logarítimicos  en cada paso están identicamente distribuidos, entonces el retorno logarítmicos sobre todo el intervalo $[t_0,t_f]$ es igual a 

\[
\mathbb{E}\left(\ln\left(\frac{S_n}{S_0}\right)\right)=n\mathbb{E}\left(\ln\left(\frac{S_1}{S_0}\right)\right)=\mu_n\tau
\]

Ahora se asume que $\mu_n$ converge a una constante
\[
\mu_n\to\mu_{RW}, \quad n\to \infty
\]
A esta constante se le llama drift.
* La constante $\sigma$: Si se define $\sigma^2_n$ la varianza de los retornos logarítmicos por cada paso entonces

\[
\sigma_n^2=\frac{1}{h_n}\text{Var}\left(\ln\frac{S_1}{S_0}\right)
\]

Donde la varianza por la forma en que se distribuyen los retornos logarítmicos entonces

\[
\sigma_n^2h_n=p_n(1-p_n)\left[\ln\frac{S_1}{S_0}\right]
\]

Como los retornos logaritmicos están i.i.d. entonces se cumple que la varianza del retorno en el intervalo $[t_0,t_f]$ es $n$ veces la varianza de cada paso de tiempo
\[
\text{Var}\left(ln\frac{S_n}{S_0}\right)=n\text{Var}\left(\frac{S_1}{S_0}\right)
\]
Se asume que $\sigma^2_n\to \sigma_2>0$ cuando $n\to \infty$. Esto se le llama la volatilidad del precio de la seguridad. 

Es importante aquí recalcar que se puede establecer una relación entre lo que sería $m-q$ y $\sigma$ para poder determinar el drift en términos de estos dos de tal forma que se logra obtener
\[
\mu_{RW}=m-q-\frac{\sigma^2}{2}
\]
Sin embargo tal y como lo expone Cox(1979) el determinar el valor de $m$ se puede volver un poco engorroso, por lo que tal y como lo propone Cox (1979) se asumir que el drift sea aproximado por la media muestral, así como lo es la volatilidad que puede ser aproximada mediante la volatilidad. Ahora para $n$ lo suficientemente grande se establece que se cumple lo siguiente

\[
u_n\approx e^{\sigma\sqrt{h_n}},\quad d_n\approx e^{'\sigma\sqrt{h_n}}, \quad p_n\approx \frac{1}{2}+\frac{\mu_{RW}}{\sigma}\sqrt{h_n}
\]

Ahora los inversores pueden ser más o menos adversos al riesgo. Sin embargo a partir del modelo CRR se puede proponer que los inversores sean neutrales al riesgo, en estos casos se establece como el precio del activo está compuesto continuamente mediante una tasa libre de riesgo $r$ menos la tasa de dividendos $q$. De tal forma que para este caso de inversores con riesgo neutral se obtiene
\[
u_n\approx e^{\sigma\sqrt{h_n}},\quad d_n\approx e^{'\sigma\sqrt{h_n}}, \quad p_n\frac{e^{(r-q)h_n}-d_n}{u_n-d_n}
\]

Note que para la primera lista de ecuaciones se emplea implícitamente el valor de $m$ mientras que para la segunda se ha empleado una tasa libre de riesgo, ahora bajo el modelo de Black y Scholes para la valoración de opciones la tasa libre de riesgo es independiente de $m$. De tal forma que es erroneo pensar que se cumple, al menos en este trabajo

\[
r=m
\]

En las siguiente subsección se procede a presentar lo que son las c
## Opciones

Las opciones son un contrato entre dos partes, en el cual uno de los involucrados tiene la posibilidad de no ejercer el contrato cuando este no le sea favorable. En este caso al vendedor de la opción se le llama escritor que se dice toma la posición corta, mientras el comprador se dice que toma la posición larga. Las opciones a trabajar son las de compra y las de venta.

Tal y como lo destacan Boudreault y Renaud () una opcion de compra da el derecho de obtener en un momento establecido entre las partes un activo a un precio establecido $K$ llamado precio de ejercicio, al precio $S_T$ donde $T$ es el momento de establecido donde se puede ejercer el derecho hay dos posibilidades.

1. $S_T>K$ en este caso se dice que la opción está en el dinero, ya que en este caso es conveniente ejercer el derecho.
2. $S_T\leq K$ en este caso se dice que la opción está fuera del dinero, ya que no es razonable ejercer el derecho, ya que se estaría comprando algo de menor valor o del mismo valor al establecido como el de ejercicio, en cuyo caso se va establecer el poseedor del derecho decide no ejercer la opción.

Los flujos de dinero en el caso de la posición larga vienen dados por 

```{r}
tiempoLongCall<-c("Momento $t_0$","Momento $T$")
SmenorK<-c("$-C_0$","$0$")
SmayorK<-c("$-C_0$","$S_T-k$")
tablaLongCall<-data.frame("Tiempo/Escenario"=tiempoLongCall,"$S_T< K$"=SmenorK,"$S_T \\geq K$"=SmayorK)
tablaLongCall%>%kbl()%>%kable_material()
```

Las opciones se pueden emplear en distintas circunstancias entre las motivaciones para escribir o comprar una opción están la especulación o el cubrirse algún riesgo. De tal forma que se pueden establecer distintas estrategias de compra y venta de opciones combinado con otros instrumentos de inversión de tal forma que se puedan replicar portafolios. Un aspecto importantes es que se puede concluir que las posibilidades con opciones existen, sin embargo rápidamente los mercados financieros hacen que esa oportunidad que existía hacia algunos instantes desaparezcan.

De una forma análoga se puede establecer que las opciones de venta las cuales son un derecho de poder vender un activo a un precio establecido por ambas partes y que como el caso de las opciones de compra es llamado precio de ejercicio $K$ en este caso contrario al caso de las opciones de compra el derecho es ejercido cuando el precio de $S_T$ es menor que el precio de ejercicio y si es mayor o igual no es ejercido. Los flujo en el caso de la posición larga vienen dados por

```{r}
tiempoLongCall<-c("Momento $t_0$","Momento $T$")
SmenorK<-c("$-C_0$","$K-S_T$")
SmayorK<-c("$-C_0$","$0$")
tablaLongCall<-data.frame("Tiempo/Escenario"=tiempoLongCall,"$S_T\\leq K$"=SmenorK,"$S_T$ > $K$"=SmayorK)
tablaLongCall%>%kbl()%>%kable_material()
```
## Precio de las opciones

Ahora surge la duda cuál debería ser el precio que debería tener una opción. Las opciones tienen una larga historias, pero el cómo establecer el precio tuvo un gran cambio en el año 1973 cuando Black y Scholes presentaron un modelo con el cuál se lograba obtener un precio de equilibrio para las opciones. Esta subsección se centrará en el cómo se estable el precio de una opción, sin embargo con una matemática menos avanzada que con el modelo establecido por Black y Scholes, y basado en el uso de árboles binomiales presentados en una de las subsecciones anteriores.

El precio que tendrán la opción será establecido de acuerdo a los distintos precios que puede llegar a tener el activo subyacente después de $n$ pasos de tiempo, de tal forma que no haya una oportunidad de arbitraje con esta. Para el caso de una opción de compra tal y como lo establece Cox (1979) se tiene que su valor se basará en la diferencia que habrá entre el precio del activo subyacente y el precio de ejercicio. Así para el caso de un árbol binomial de un periodo se cumple que en el caso de que el precio aumente $C_u=\max\{0,uS_0-K\}$ y en el caso de que dismuya $C_d=\max\{0,dS_0-K\}$, ya que si el precio del activo es menor que el precio de ejercicio la opción está fuera del dinero. 

Ahora se cumple que la probalidad de que el precio aumente es igual a $p$ mientras que la probailidad de que este dismuya es igual $1-p$, de acuerdo a Cox basado en que se tiene un portafolio en el cual se encuentra el activo subyacente y una seguridad libre de riesgo el precio de la opción para evitar cualquier oportunidad de arbitraje es

\[
C=\frac{pC_u+(1-p)C_d}{1+r}
\]

Ahora para el caso de se tenga un árbol binomial de dos periodos entonces el valor de la opción después de dos pasos es si el activo subyacente aumenta dos veces su precio entonces $C_{uu}=\max\{0,u^2S-k\}$, en el caso de dos disminuciones $C_{dd}=\max\{0,d^2S-k\}$ y por la propiedad de recombinación el precio del activo subyacente es igual si aumenta y posteriormente disminuye o si primeramente dismuye y posteriormente aumenta entonces $C_{du}=C_{ud}=\max\{0,udS-k\}$. 
\textbf{grafico}

Bajo esto se tiene que en el periodo $t_1$ la opción tiene los siguientes precios 

\[
\begin{split}
&C_u=\frac{pC_{uu}+(1-p)C_{ud}}{1+r}\\
&C_d=\frac{(1-p)C_{dd}+pC_{du}}{1+r}\\
\end{split}
\]
Ahora entonces basado en lo visto para el caso de un periodo y esto se cumple que 
\[
C=\frac{p^2C_{uu}+2p(1-p)^2C_{ud}+(1-p)^2C_{dd}}{(1+r)^2}
\]

De forma recursiva entonces se puede concluir que para un árbol de $n$ periodos
\[
C=\frac{\sum_{i=0}^{n}\left(\frac{n!}{i!(n-i)!}p^{i}(1-p)^{n-i}\max\{0,u^id^{n-i}S_0-K\}\right)}{(1+r)^{\tau}}
\]

Ahora el cálculo se puede volver más eficiente encontrando $a\in \{0,1,2,\dots ,n\}$ tal que
\[
u^{a}d^{n-a}S_0-K>0
\]

Que manipulando algebraicamente da como resultado $a>\frac{K}{S_0d^n\ln{\frac{u}{d}}}$. Entonces encontrando $a$ que cumpla con estas dos condiciones se puede establecer
\[
C=\frac{\sum_{i=a}^{n}\left(\frac{n!}{i!(n-i)!}p^{i}(1-p)^{n-i}u^id^{n-i}S_0-K\}\right)}{(1+r)^{\tau}}
\]

De forma análoga se puede establecer para el caso de las opciones de venta el precio de la opción de venta $P$ es igual a

\[
P=\frac{\sum_{i=0}^{a-1}\left(\frac{n!}{i!(n-i)!}p^{i}(1-p)^{n-i}u^id^{n-i}S_0-K\}\right)}{(1+r)^{n}}
\]

Ahora se procede a ver lo que es la Curva de Rendimiento Soberana.

## Curva de Rendimiento Soberana

La curva soberana es una estructura temporal de tasas que se emplea para valorar distintos instrumentos financieros. "Su comportamiento refleja en alguna medida las expectativas futuras del mercado sobre diversas variables económicas y sirve como una herramienta para la valoraciónde instrumentos financieros" (BCCR,s.f.). Esta curva se calcula a partir de distintos instrumentos financieros como bonos y para estos modelos emplean distintas modelos como lo son las curvas paramétricas.

La curva soberana del Banco Central de Costa Rica (BBCR) es determinada mediante el modelo de Svensson o el de Nelson y Siegel. Según el BCCR la curva paramétrica para el rendimiento es
\[
y(t)=\beta_{0}+\beta_{1}\left(\frac{1-e^{\frac{-t}{\tau_1}}}{\frac{t}{\tau_1}}\right)+\beta_2\left(\frac{1-e^{\frac{-t}{\tau_1}}}{\frac{t}{\tau_1}}-e^{\frac{-t}{\tau_1}}\right)+\beta_3\left(\frac{1-e^{\frac{-t}{\tau_2}}}{\frac{t}{\tau_2}}-e^{\frac{-t}{\tau_2}}\right)
\]

Los seis parámetros del modelo pueden ser calculados mediante una interpolación, de tal forma que se toman los datos que brinda el BCCR a una fecha y se minimiza
\[
\sum_{i=1}^{n}\left(y(t_n)-r_n\right)^2
\]
Esto para el plazo de 10 años.











# Metodología

# Analisis de datos

Los datos de los precios del activo subyacente a analizar, en este caso acciones,  son provenientes de la empresa Holcim Costa Rica, suministrados por el sitio web Investing.com y comparados con los suministrados por la misma empresa en los periodos que se registraron, pues los mismos no contaban con un registro tan periódico como los del sitio web.

```{r}

ggplot(Precios,aes(x=Fecha, y =Último))+
  geom_line()+
  geom_point(aes(x =Montos$FechaDePago[1], y=Último[Fecha==Montos$FechaDePago[1]]), size =1,color="blue" )+
  geom_point(aes(x =Montos$FechaDePago[2], y=Último[Fecha==Montos$FechaDePago[2]]), size =1,color="blue" )+
  geom_point(aes(x =Montos$FechaDePago[3], y=Último[Fecha==Montos$FechaDePago[3]]), size =1,color="blue" )+
  geom_point(aes(x =Montos$FechaDePago[4], y=Último[Fecha==Montos$FechaDePago[4]]), size =1,color="blue" )+
  geom_point(aes(x =Montos$FechaDePago[5], y=Último[Fecha==Montos$FechaDePago[5]]), size =1,color="blue" )+
  labs(y = "Precios",x = "Tiempo" ,caption = "Fuente: Elaboración propia, con datos del ....")+theme_minimal()+theme(legend.position="bottom",plot.caption=element_text(hjust=0))



```

Como se aprecia en el grafico el precio de las acciones se mantiene estable por intervalos de tiempo, para luego sufir un cambio repentino durante los el pediodo de 2019 y gran parte del 2020 



Para un mejor cálculo de la opción se va a trabajar desde febrero+-

Los días no busrsatiles en CR, son tales

Banc
sacar 

Se va a trabajar con los datos de la curva soberana obtenidos de la página del Banco Central de Costa Rica, los mismos son establecidos para la semana del 23 de junio del año 2021 al 29 de junio de año 2021. Se tiene que las observaciones son: 

Agregar titulos fecha de madurancion y tasas


```{r}
tasasBCCR%>%kbl()%>%kable_material()
tablaKableConDiaNB
```

Aplicando el modelo de $Sevenson$ (cita del documento), se puede obtener una curva continua, la cual se representa en el siguiente grafico:


```{r}
#### Se calculan los parametros



# t<-c(0,0,0,0.05)
# parametrosCurva<-fitNS(t,c(1,1*30,3*30,6*30,9*30,1*360,2*360,3*360,5*360,7*360,10*360),Curva_soberana$,1000,datosMaximo$CuponSemestral)
```



# Análisis del árbol e implementación

# Resultados
Se presentan obtenidos al aplicar el modelo para el precio de las opciones a 3, 6 meses y a un año empleando como precio de ejercicio el precio con el que se cuenta para el activo subyacente y basado en la cantidad de días bursátiles a partir del día miércoles 30 de junio del 2021.

```{r}
## La cantidad de días hábiles se va tomar como la cantidad de pasos que se van a hacer
## Recuerde que las opciones que se van a calcular son para el tipo europeo
### Cantidad de días bursátiles a partir del 30 de junio hasta el primero de octubre del 2021
### En este caso se usará como tasa libre de riesgo la brindada por la curva soberana, note que para que no hayan oportunidades de riesgo se debería cumplir d<1+r<u donde r es la tasa libre de riesgo de un periodo
nTrimestral<-as.Date("01/10/2021",format="%d/%m/%Y")-as.Date("30/06/2021",format="%d/%m/%Y")-length((tablaConDiaNB%>%filter(Fecha>=as.Date("01/10/2021",format="%d/%m/%Y")))$Fecha)
### Cantidad de días bursátiles a partir del 30 de junio hasta el dos de enero del 2021 (Teniendo en cuenta del 1 de enero) 
nSemestral<-as.Date("02/01/2022",format="%d/%m/%Y")-as.Date("30/06/2021",format="%d/%m/%Y")-length((tablaConDiaNB%>%filter(Fecha>=as.Date("01/10/2021",format="%d/%m/%Y")))$Fecha)-1
### Cantidad de días bursátiles a partir del 30 de junio hasta el 30 de junio del 2021 (tomando como punto de referencia los días no bursátiles del presente año)
nAnual<-as.Date("30/06/2022",format="%d/%m/%Y")-as.Date("30/06/2021",format="%d/%m/%Y")-length((tablaConDiaNB%>%filter(Fecha>=as.Date("01/10/2021",format="%d/%m/%Y")))$Fecha)-4
### Anteriormente se determinó la volatilidad diaria entonces se usará esta ya que se está usando la cantidad días como la cantidad de pasos
sigma<-0.06 ### A la espera
### Se trabaja de forma anualizada por lo que se tiene que los valores hn correspondientes son
## Tres meses equivalen a un cuarto del año
hnTrimetral<-0.25/as.numeric(nTrimestral)
## Seis meses equivalen medio año por lo que
hnSemestral<-0.5/as.numeric(nSemestral)
## Un año equivale a 1
hnAnual<-1/as.numeric(nAnual)
### Tasas libres de riesgo en cada periodo anualizados

### El precio de ejercicio con el que vamos a escribir las opciones es el último con el que se cuenta
#K<-Precios$Último[length(Precios$Último)]

### Opciones put y call para el caso de trimestral
#precioC(K,K,nTrimestral,hnTrimetral,sigma)
#precioP(K,K,nTrimestral,hnTrimetral,sigma)
### Opciones put y call para el  caso semestral
#precioC(K,K,nSemestral,hnSemestral,sigma)
#precioP(K,K,nSemestral,hnSemestral,sigma)
### Opciones put y call para el caso anual
#precioC(K,K,nAnual,hnAnual,sigma)
#precioP(K,K,nAnual,hnAnual,sigma)
```
#Conclusión

Marco teórico, curva soberana


Metodologia, periodo y que datos
Conclusiones

